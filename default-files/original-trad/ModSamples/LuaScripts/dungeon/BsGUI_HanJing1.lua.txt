require("gui/WindowUtils")
require("GameMath")

require("dungeon/BsLogic_HanJing1")

local windowPanel
local windowController

local btnCamera = nil
local btnFinish = nil

local groupCmdBtns = nil
local btnRetreat = nil

local groupInfoBox = nil
local btnSystem = nil

local btnTest
local skillslots

local playerInfoPanel = nil

local mobileCtl;
local isMobileUI = false;

local GameCoreHelper = CS.GameCoreHelper

local timerTickInterval = 0.05

local playersInfoBar
local actionBar

local cachedSlotDatas = {}

--初始化控件
function initPanel(_view, _controllerScript)
    windowPanel = _view
    windowController = _controllerScript

    isMobileUI = CS.GameTools.IsMobileMode();

    mobileCtl = windowPanel:GetController("mobile");

    --绑定按钮事件

    btnFinish = windowPanel:GetChild("btn_finish").asButton;
    windowController:SetBattleOverBtn(btnFinish);

    groupInfoBox = windowPanel:GetChild("group_infobox").asGroup;
	btnSystem = windowPanel:GetChildInGroup(groupInfoBox, "btn_menu").asButton;
    btnSystem.onClick:Add(OnClickBtnSystem);
    local battleInfoGroup = windowPanel:GetChildInGroup(groupInfoBox, "group_info").asGroup;
    local txtBattleInfo = windowPanel:GetChildInGroup(battleInfoGroup, "battle_info").asTextField;
    local txtBattleTimeInfo = windowPanel:GetChildInGroup(battleInfoGroup, "time_info").asTextField;
    windowController:SetBattleInfoComponents(battleInfoGroup, txtBattleInfo, txtBattleTimeInfo);

    local _customUI = windowPanel:GetChild("custom_ui").asCom;

    local playerPanelComp;
    if isMobileUI then
        mobileCtl.selectedIndex = 1;

        playerPanelComp = windowPanel:GetChild("player_bar_m").asCom;
        playerInfoPanel = windowController:CreatePlayerPanel(playerPanelComp);

        windowController:CreateStandardMobileActionBar(_customUI);
    else
        mobileCtl.selectedIndex = 0;

        playerPanelComp = windowPanel:GetChild("player_bar").asCom;
        playerInfoPanel = windowController:CreatePlayerPanel(playerPanelComp)

        local actionBarComp = playerInfoPanel.bindView:GetChild("action_bar").asCom
        skillslots = actionBarComp:GetChild("list_slots").asList
        local rollActionWrapper = playerInfoPanel.bindView:GetChild("rollaction_wrapper").asCom
        windowController:CreateActionBarByUIComp(actionBarComp, rollActionWrapper, actionBarSlotCount, "DgBsGUI1#MyBattleSpecialSlot1")
    end

    local playersInfoBarWrapper = windowPanel:GetChild("players_infobar_wraper").asCom;
    playersInfoBar = windowController:CreatePartyPlayersInfoBar(playersInfoBarWrapper, 0)
    playersInfoBar.bindView.visible = true;

    --本地化处理
    local defeatTitleCN = playerInfoPanel.bindView:GetChild("defeat_tile").asImage
    local defeatTitleEN = playerInfoPanel.bindView:GetChild("defeat_tile_en").asImage
    if CS.GameTools.IsChineseLanguage() then
        defeatTitleEN.visible = false
    else
        defeatTitleCN.visible = false
    end

    --InitBagPanel(windowPanel:GetChild("bag_box").asCom)

    txtLabelKillCount = playerInfoPanel.bindView:GetChild("txt_killcount_val").asTextField;

    --创建默认控件
    windowController:CreateWindowComponent("res_box", windowPanel:GetChildInGroup(groupInfoBox, "res_box_wraper").asCom, 5, CS.UnityEngine.Vector2(0, 0))
    windowController:CreateWindowComponent("vars_watcher", windowPanel:GetChild("var_watcher_wraper").asCom, 2, CS.UnityEngine.Vector2(0, 0))
    windowController:CreateWindowComponent("minimap", windowPanel:GetChild("minimap_wraper").asCom, 8, CS.UnityEngine.Vector2(0, 0))
    windowController:CreateWindowComponent("revive_info", windowPanel:GetChild("revive_info_wraper").asCom, 4, CS.UnityEngine.Vector2(0, 0))
    windowController:CreateWindowComponent("enemy_info", windowPanel:GetChild("enemy_info_wraper").asCom, 4, CS.UnityEngine.Vector2(0, 0))

    local blackMask = windowPanel:GetChild("black_mask").asGraph;
    --设置场景所需UI遮罩层
    windowController:SetSceneMaskLayer(blackMask)
    --设置UI控制器
    local stateCtl = windowPanel:GetController("ctl_state")
    windowController:SetStateController(stateCtl)
    --设置自定义UI相关
    windowController:SetExpBarFillAmountRange(0.14, 0.44);
    actionBar = windowController:GetBattleActionBar();
    actionBar:RegSlotRenderCallback(OnRenderActionBarSlot);

    playerInfoPanel.bindView.visible = true
    windowController:SetBattleInfoShowMode(1);          --显示玩家资源

    onUpdateMyInfo()
    ResetActionBar()

    --设置自定义技能栏位

    --增加计时器事件
	--CS.FairyGUI.Timers.inst:Add(timerTickInterval, 0, onTimerTickUpdate);

end

function onPanelDestory()
    --移除计时器事件
    --CS.FairyGUI.Timers.inst:Remove(onTimerTickUpdate);
end

--热键按下事件(-1代码默认为back键)
function onHotkeyPressed(_keycode)
    if _keycode == -1 then
        return OnBackKey()
    end
    return false
end

--游戏信息面板更新事件
function onUpdateGameInfo()
    --更新背包UI
    --UpdateBagItemList()
end

--面板每秒事件
function onPanelSecondUpdate()
    onUpdateMyInfo()
end

--自定义动作条渲染回调
function OnRenderActionBarSlot(_tagSlot)
    if isMobileUI or _tagSlot == nil or _tagSlot.SlotType ~= 1 then
        return
    end
    local tagBtn = _tagSlot.bindBtn
    local bindData = cachedSlotDatas[_tagSlot]
    if bindData == nil then
        bindData = {}
        bindData.rankSpotBg = tagBtn:GetChild("sp_bg").asImage
        bindData.rankSpot1 = tagBtn:GetChild("sp_rank1").asImage
        bindData.rankSpot2 = tagBtn:GetChild("sp_rank2").asImage
        bindData.rankSpot3 = tagBtn:GetChild("sp_rank3").asImage
        bindData.rankSpot4 = tagBtn:GetChild("sp_rank4").asImage
        bindData.rankSpot5 = tagBtn:GetChild("sp_rank5").asImage
        bindData.rankSpot6 = tagBtn:GetChild("sp_rank6").asImage
        cachedSlotDatas[_tagSlot] = bindData
    end
    bindData.rankSpotBg.visible = false
    bindData.rankSpot1.visible = false
    bindData.rankSpot2.visible = false
    bindData.rankSpot3.visible = false
    bindData.rankSpot4.visible = false
    bindData.rankSpot5.visible = false
    bindData.rankSpot6.visible = false
end

function onUIMessage(_msgType, _msgArg)
    if _msgType == "info_updated" then
        onUpdateMyInfo()
    elseif _msgType == "player_inited" then
        onPlayerInited()
    elseif _msgType == "skills_changed" then
        ResetActionBar()
    elseif _msgType == "settings_updated" then
        --此消息由框架内部发送
        --UpdateBtnNames()
        --UpdateBagItemList()
    end
end

function onPlayerInited()
    playerInfoPanel.bindView.visible = true
end

function onUpdateMyInfo()
    --定制信息板更新
    txtLabelKillCount.text = tostring(playerUnitDefeatCount)
end

function OnClickBtnSystem()
    windowController:OnWindowCmd("system")
end

function OnClickBtnCamera()
    windowController:OnWindowCmd("camera")
end

function OnClickBtnRetreat()
    windowController:OnWindowCmd("retreat")
end

function ResetActionBar()
    windowController:SetActionBarSkill(resetRoleActionBarInfo);
end

function OnBackKey()
    return false
end
