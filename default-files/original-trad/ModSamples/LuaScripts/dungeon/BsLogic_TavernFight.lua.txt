require("GameMath")
require("GameUtils")

curBattleScene = nil
--游戏状态 0：未开始  1：已开始 2：结束
curGameState = 0;

--当前搏击战斗类型 0：酒馆被殴  1：酒馆挑战  2：比武大会  3:自定义战斗
curFightType = 0;

playerUnitDefeatCount = 0

playerUnitID = 0

playerUnit = nil
playerRole = nil
isPlayerDown = false;

RES_ID_MONEY = "金钱"

local GameCoreHelper = CS.GameCoreHelper

--当前斗志层数
curFightingSpiritNum = 0;

FS_BUFF_ID = "搏击斗志";

BarGirlRoleID = "";
RandomBarGirlRoleID = "通用酒吧女郎";


allPlayerAreaPoolCount = 0;
allPlayerAreaPool = {};

allEnemyAreaPoolCount = 0;
allEnemyAreaPool = {};

allBonusAreaPoolCount = 0;
allBonusAreaPool = {};

--我方英雄刷新间隔
curFriendSpawnInterval = 25;
--敌方英雄刷新间隔
curEnemySpawnInterval = 15;

friendHeroesQueue = nil;
enemyHeroesQueue = nil;

--默认主角增加的地城属性
defaultPlayerAddStat = "s_移速,-100|s_标准攻击百分比,150";
--默认NPC增加的地城属性
defaultNpcAddStat = "s_标准生命百分比,100|s_标准攻击百分比,175|s_移速,-150";

--增补格斗士逻辑相关
MIN_FIGHT_ROLE_NUM = 4;     --最低格斗参与人数
allRefFightersCount = 0;
refFightersFriend = 0;
refFightersEnemy = 0;

curPlayerRank = GameCoreHelper.GetIntVar("FIGHT_RANK");

--场景初始化
function initBattleScene(_bs)
    curBattleScene = _bs;
    curGameState = 0;

    --禁用普攻
    curBattleScene:SetIsDisableClickAttack(true);


    --创建环境变量
    allPlayerAreaPoolCount = 0;
    local tagAreasPool = curBattleScene:GetAllSpawnAreasByTag("player");
    for i=0,tagAreasPool.Count-1 do
        local tagArea = tagAreasPool[i];
        allPlayerAreaPool[allPlayerAreaPoolCount] = tagArea;
        allPlayerAreaPoolCount = allPlayerAreaPoolCount + 1;
    end
    allEnemyAreaPoolCount = 0;
    tagAreasPool = curBattleScene:GetAllSpawnAreasByTag("enemy");
    for i=0,tagAreasPool.Count-1 do
        local tagArea = tagAreasPool[i];
        allEnemyAreaPool[allEnemyAreaPoolCount] = tagArea;
        allEnemyAreaPoolCount = allEnemyAreaPoolCount + 1;
    end
    allBonusAreaPoolCount = 0;
    tagAreasPool = curBattleScene:GetAllSpawnAreasByTag("bonus");
    for i=0,tagAreasPool.Count-1 do
        local tagArea = tagAreasPool[i];
        allBonusAreaPool[allBonusAreaPoolCount] = tagArea;
        allBonusAreaPoolCount = allBonusAreaPoolCount + 1;
    end

    --读取变量
    curFightType = GameCoreHelper.GetIntVar("cur_fight_type");
    BarGirlRoleID = GameCoreHelper.GetStrVar("fight_bar_girl");
    local allFirendHeroes = GameCoreHelper.GetStrVar("fight_roles_friend");
    local allEnemyHeroes = GameCoreHelper.GetStrVar("fight_roles_enemy");

    --读取副本设置
    local configSpawnIntF = curBattleScene:GetDungeonMapTag("friend_spawn_int");
    if not IsEmptyOrNil(configSpawnIntF) then
        curFriendSpawnInterval = tonumber(configSpawnIntF);
    end
    local configSpawnIntE = curBattleScene:GetDungeonMapTag("enemy_spawn_int");
    if not IsEmptyOrNil(configSpawnIntE) then
        curEnemySpawnInterval = tonumber(configSpawnIntE);
    end

    if curPlayerRank == 1 then
	    curFriendSpawnInterval = 27;
        curEnemySpawnInterval = 27;
	elseif curPlayerRank == 2 then
	    curFriendSpawnInterval = 22;
        curEnemySpawnInterval = 22;	
    end	

    friendHeroesQueue = GameCoreHelper.GetEmptyRoleList();
    ReadRoleListFromStr(friendHeroesQueue, allFirendHeroes);

    enemyHeroesQueue = GameCoreHelper.GetEmptyRoleList();
    ReadRoleListFromStr(enemyHeroesQueue, allEnemyHeroes);

    --人数不足增补格斗士逻辑
    allRefFightersCount = 0;
    refFightersFriend = 0;
    refFightersEnemy = 0;
    local curAllNum = friendHeroesQueue.Count + enemyHeroesQueue.Count;
    if curAllNum < MIN_FIGHT_ROLE_NUM then
        allRefFightersCount = MIN_FIGHT_ROLE_NUM - curAllNum;
        refFightersEnemy = math.floor(allRefFightersCount * 0.66666) + 1;
        refFightersFriend = allRefFightersCount - refFightersEnemy;
    end
	
    if curPlayerRank == 1 and refFightersFriend < 1 then
	    refFightersFriend = 2;
	elseif curPlayerRank == 2 and refFightersFriend < 1 then
	    refFightersFriend = 1;
    end	

    local allPlayers = curBattleScene:GetAllPlayersInBattle()
    local tagPlayer
    local tagSide
    local initPos;
    local initDir = 0
    local playerRole = GameCoreHelper.GetRoleCopy(ID_PLAYER_ID);
    if playerRole ~= nil then
        PreprocessRole(playerRole);
        for index=0,allPlayers.Count-1 do
            tagPlayer = allPlayers[index];
            tagSide = index;
            local tagArea = GetRandomItemInPool(allPlayerAreaPool, allPlayerAreaPoolCount);
            if tagArea ~= nil then
                initPos = tagArea.centerPos;
                initDir = tagArea.initDir;
            else
                initPos = curBattleScene:GetBattleRealPosByMapPos(0, 0);
            end
            curBattleScene:SetPlayerUnitByRole(tagPlayer.actorID, playerRole, tagSide, initPos.x, initPos.y, initDir);
        end
    end

    curBattleScene:DelayExecute(3.0, function ()
        BattleStart()
    end)
end

function PreprocessRole(_tagRole)
    _tagRole:SetRoleEquipsByStr("||||", false);
    _tagRole.natureSpList:Clear();
    _tagRole.distributeSpList:Clear();
    _tagRole.skillPagesList:Clear();
    curPlayerRank = GameCoreHelper.GetIntVar("FIGHT_RANK");

    --如果是主角特殊处理技能列表，否则按照NPC TAG来处理
    if _tagRole.roleID == ID_PLAYER_ID then
        _tagRole.extAttachedCmd = "酒馆搏击_主角";
        --主角设置相关默认属性及触发器
        local _playerSkills = GetSavedFightSpListStr();
        if IsEmptyOrNil(_playerSkills) then
            LearnFightSkills(nil, "头槌,1|膝盖顶,1|吼叫,1|直拳,1");
            _playerSkills = GetSavedFightSpListStr();
        end
        _tagRole:SetSkills(_playerSkills, "");
        _tagRole:SetDungeonSkill("刺拳,1");

        _tagRole:UpdateRoleStatu();
        local addVal = math.floor(_tagRole.curRealStatu:getVal("s_攻击") * 0.5);
        _tagRole.extraStatu:AddVal("s_攻击", addVal);

        curBattleScene:SendUIMessage("skills_changed", "")

    else

        _tagRole:UpdateRoleStatu();
        
        local addVal_atk = math.floor(_tagRole.curRealStatu:getVal("s_攻击") * 0.5);
        if curPlayerRank > 4 then
            addVal_atk = math.floor(_tagRole.curRealStatu:getVal("s_攻击") * 0.5) + 300;
        elseif curPlayerRank == 4 then
            addVal_atk = math.floor(_tagRole.curRealStatu:getVal("s_攻击") * 0.5) + 200;
        elseif curPlayerRank < 4 then
            addVal_atk = math.floor(_tagRole.curRealStatu:getVal("s_攻击") * 0.5);
        end
        _tagRole.extraStatu:AddVal("s_攻击", addVal_atk);

        local addVal_hp = 100;
        if curPlayerRank > 4 then
            addVal_hp = 1500;
        elseif curPlayerRank == 4 then
            addVal_hp = 1000;
        end
        _tagRole.extraStatu:AddVal("s_生命", addVal_hp);


        _tagRole.extAttachedCmd = "酒馆搏击_英雄";
        local dgSkillInfo =_tagRole:GetTagValue("fight_dgskill");
        if IsEmptyOrNil(dgSkillInfo) then
            --如果未配置采用默认技能表
            dgSkillInfo = "直拳,1";
        end
        _tagRole:SetDungeonSkill(dgSkillInfo);

        local tagSpList = _tagRole:GetTagValue("fight_skills");
        if IsEmptyOrNil(tagSpList) then
            --如果未配置采用默认技能表
            tagSpList = "膝盖顶|刺拳|飞腿|蓄力冲刺";
        end
        _tagRole:LearnSkills(tagSpList, false);
    end

    --重新结算状态
    _tagRole:UpdateRoleStatu();

    --替换战斗里的角色信息
    curBattleScene:ReplaceCurBattleRoleInfo(_tagRole.roleID, _tagRole);
end

isRookie = GameCoreHelper.GetIntVar("搏击新手教学");
--curPlayerRank
function BattleStart()
    --游戏开始
	
    if isRookie == 0 and curPlayerRank < 1 then
        BarGirlBB(GetGameString("lua_script_str_297"));
    else
        BarGirlBB(GetGameString("lua_script_str_130"));
    end
	
    --BarGirlBB(GetGameString("lua_script_str_130"));
    TrySpawnEnemyHero();

    isPlayerDown = false;
    curGameState = 1;
end

--销毁场景接口
function onBattleSceneDestory()
    
end

--单位事件
function onUnitEvent(_tagUnit, _eventType, _eventArg)
    if _eventType == "set_player" then
        --设置玩家控制单位事件
        onSetPlayerUnit(_tagUnit)
    elseif _eventType == "level_changed" then
        --单位等级发生改变事件
        onUnitLevelChanged(_tagUnit, tonumber(_eventArg))
    elseif _eventType == "on_die" then
        --单位被击倒事件
        onUnitDie(_tagUnit)
    end
end

local friendSpawnTimer = 0;
local enemySpawnTimer = 0;
local bounsTick = 0;
local friendSpawnTimeNum = 0;
local enemySpawnTimeNum = 0;
local EnemyAnnouncement = 0;
local FriendAnnouncement = 0;
--场景每秒事件
function onSecondUpdate()
    if curGameState ~= 1 then
        return;
    end

    --检查是否胜利
    if CheckIsBattleOver() then
        return;
    end

    if isRookie == 0 and curPlayerRank < 1 then
	
    elseif not isPlayerDown then	
        --刷新友方英雄
		EnemyAnnouncement = 0;
		FriendAnnouncement = 0;
        friendSpawnTimer = friendSpawnTimer + 1;
		friendLastTimer = curFriendSpawnInterval - friendSpawnTimer;
		
		if friendLastTimer == 5 and friendHeroesQueue.Count > 0 then
		    FriendAnnouncement = 1;
		elseif friendLastTimer == 5 and refFightersFriend > 0 then
		    FriendAnnouncement = 1;	
        end		
		
        if friendSpawnTimer >= curFriendSpawnInterval then
            TrySpawnFriendHero();
            friendSpawnTimer = 0;
            friendSpawnTimeNum =  friendSpawnTimeNum + 1;
        end

        --刷新敌方英雄
        enemySpawnTimer = enemySpawnTimer + 1;
		enemyLastTimer = curEnemySpawnInterval - enemySpawnTimer;
		
        if enemyHeroesQueue.Count > 0 and curBattleScene:GetActiveUnitCount(1) < curBattleScene:GetActiveUnitCount(0) then
            TrySpawnEnemyHero();
            enemySpawnTimer = 0;
            enemySpawnTimeNum =  enemySpawnTimeNum + 1;
			BarGirlBB(GetGameString("lua_script_str_296"));
		elseif enemyLastTimer == 5 and enemyHeroesQueue.Count > 0 then
		    EnemyAnnouncement = 1;
		elseif enemyLastTimer == 5 and refFightersEnemy > 0 then
		    EnemyAnnouncement = 1;
        end
		
        if EnemyAnnouncement == 1 and  FriendAnnouncement == 1 then
            BarGirlBB(GetGameString("lua_script_str_298"));		
		    EnemyAnnouncement = 0;
		    FriendAnnouncement = 0;
        end
		
        if EnemyAnnouncement == 1 then
            BarGirlBB(GetGameString("lua_script_str_295"));		
		    EnemyAnnouncement = 0;
        end			
		
        if FriendAnnouncement == 1 then
            BarGirlBB(GetGameString("lua_script_str_294"));		
		    FriendAnnouncement = 0;
        end			


        if enemySpawnTimer >= curEnemySpawnInterval then
            TrySpawnEnemyHero();
            enemySpawnTimer = 0;
            enemySpawnTimeNum =  enemySpawnTimeNum + 1;
        end
        
        --奖励事件
        bounsTick = bounsTick + 1;
        if bounsTick >= 20 then
            AddBonusItemToBf();
            bounsTick = 0;
        end
    end

end

--击败单位接口
function onUnitDefeatEnemy(_thisUnit, _tagUnit)
    if (_thisUnit == playerUnit) then
        --增加统计接口
        
        playerUnitDefeatCount = playerUnitDefeatCount + 1
        curBattleScene:SendUIMessage("info_updated", "")
    end
end

--设置主角控制单位
function onSetPlayerUnit(_tagUnit)
    playerUnit = _tagUnit
    if playerUnit ~= nil then
        playerUnitID = playerUnit.unitID
        playerCurLevel = playerUnit.unitLevel
        playerRole = GameCoreHelper.GetPlayerRole()
        curFightingSpiritNum = playerUnit:GetBuffOverlay(FS_BUFF_ID)
    else
        playerUnitID = 0
    end
    --更新UI
    curBattleScene:SendUIMessage("skills_changed", "")
    curBattleScene:SendUIMessage("info_updated", "")
end

function onUnitLevelChanged(_tagUnit, _newLevel)
    if (_tagUnit == playerUnit) then
        playerCurLevel = _newLevel
        curBattleScene:SendUIMessage("info_updated", "")
    end
end

function onUnitDie(_tagUnit)
    --重置BUFF状态
    if _tagUnit == playerUnit and playerUnit ~= nil then
        isPlayerDown = true;
        curFightingSpiritNum = 0;
        curBattleScene:SendUIMessage("on_fs_updated", "");
    end
end

--单位BUFF状态更改
function onUnitBuffChanged(_tagUnit, _tagBuff, _newOverlay)
    --监视玩家角色BUFF状态
    if _tagUnit == playerUnit and playerUnit ~= nil then
        if _tagBuff.buffID == FS_BUFF_ID then
            curFightingSpiritNum =_newOverlay;
            curBattleScene:SendUIMessage("on_fs_updated", "");
        end
    end
end

--当前的酒吧女郎BB（如果存在的话）
function BarGirlBB(_bbInfo)
    if not IsEmptyOrNil(BarGirlRoleID) then
        local tagCmd = "BB*" .. BarGirlRoleID .. "#" .. _bbInfo .. "#0"
        curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
	else
        local tagCmd = "BB*" .. RandomBarGirlRoleID .. "#" .. _bbInfo .. "#0"
        curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
    end
end

--从目标池中抽取一个随机元素
function GetRandomItemInPool(_tagPool, _poolCount)
    local rndIndex = GameCoreHelper.GetRandomInt(0, _poolCount);
    return _tagPool[rndIndex];
end

--增加一个回复道具到场上
function AddBonusItemToBf()

    if friendSpawnTimeNum >= 1 and curBattleScene:GetActiveUnitCount(1) > curBattleScene:GetActiveUnitCount(0) then

    --先移除旧的奖励
       local tagCmd = "REMOVE_INTER_OBJECT*Bonus_Item";
       curBattleScene:LocalExecBsCmdLines(tagCmd, 0);

    --找随机位置刷新新奖励
       local tagBonusArea = GetRandomItemInPool(allBonusAreaPool, allBonusAreaPoolCount);
       if tagBonusArea ~= nil then
           local locationPos = curBattleScene:GetMapPosByRealPos(tagBonusArea.centerPos.x, tagBonusArea.centerPos.y);
           local location = locationPos.x .. "," .. locationPos.y
           local rndIndex = GameCoreHelper.GetRandomInt(0, 3);
           if rndIndex == 0 then
              tagCmd = "ADD_INTER_OBJECT*" .. GetGameString("lua_script_str_131") .. "#".. location .. "#chest1#chest1_open#psChestFlash1,0,0#0#Bonus_Item##酒馆搏击_鸡腿2#0"
              curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
              BarGirlBB(GetGameString("lua_script_str_132"))
           else
              tagCmd = "ADD_INTER_OBJECT*" .. GetGameString("lua_script_str_133") .. "#".. location .. "#chest1#chest1_open#psChestFlash1,0,0#0#Bonus_Item##酒馆搏击_鸡腿1#0"
              curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
              BarGirlBB(GetGameString("lua_script_str_134"))
           end  
       end
    end
end

--刷新我方英雄
function TrySpawnFriendHero()
    if friendHeroesQueue.Count > 0 then
        local tagRole = friendHeroesQueue[0];
        SpawnNpcRoleToBf(tagRole, 0);
        friendHeroesQueue:RemoveAt(0);
    elseif refFightersFriend > 0 then
        SpawnNpcRefFighterToBf(0);
        refFightersFriend = refFightersFriend - 1;
    end
end

--刷新敌方英雄
function TrySpawnEnemyHero()
    if enemyHeroesQueue.Count > 0 then
        local tagRole = enemyHeroesQueue[0];
        SpawnNpcRoleToBf(tagRole, 1);
        enemyHeroesQueue:RemoveAt(0);
    elseif refFightersEnemy > 0 then
        SpawnNpcRefFighterToBf(1);
        refFightersEnemy = refFightersEnemy - 1;
    end
end

--将一个NPC角色刷新出来
function SpawnNpcRoleToBf(_tagRole, _tagCamp)
    local initPos;
    local initDir;
    local tagArea = GetRandomItemInPool(allEnemyAreaPool, allEnemyAreaPoolCount);
    if tagArea ~= nil then
        initPos = tagArea.centerPos;
        initDir = tagArea.initDir;
    else
        initPos = curBattleScene:GetBattleRealPosByMapPos(0, 0);
    end
    PreprocessRole(_tagRole);
    curBattleScene:SpawnRoleToTagPos(_tagRole, initPos, initDir, _tagCamp, "0", "FightHero", defaultNpcAddStat);
end

--刷一个AI格斗士小兵出来
aiFightersPool1 = {"荒沙住民_搏击", "荒沙住民_搏击"};
aiFightersPool2 = {"蛮力莽汉_搏击", "蛮力莽汉_搏击"};
aiFightersPool3 = {"蛮力壮士_搏击", "蛮力壮士_搏击"};
aiFightersPool4 = {"蛮力巨人_搏击", "蛮力巨人_搏击"};

function SpawnNpcRefFighterToBf(_tagCamp)
    local tagArea = GetRandomItemInPool(allEnemyAreaPool, allEnemyAreaPoolCount);
    if tagArea ~= nil then
        local playerLevel = playerRole.roleLevel;
        local tagUnitID = "";
        if playerLevel < 5 then
            tagUnitID = GetRandomTableItem(aiFightersPool1)
        elseif playerLevel < 10 then
            tagUnitID = GetRandomTableItem(aiFightersPool2)
        elseif playerLevel < 15 then
            tagUnitID = GetRandomTableItem(aiFightersPool3)
        else
            tagUnitID = GetRandomTableItem(aiFightersPool4)
        end
        if not IsEmptyOrNil(tagUnitID) then
            local addStat = "";
            local tagCmd = "AREA_SPAWN*" .. tagArea.controlID .. "##" .. tagUnitID .. ",1#" .. _tagCamp .. "#0:15000#替补AI#" .. addStat;
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        end
    end
end

function GetRandomTableItem(_tagPool)
    local rndIndex = GameCoreHelper.GetRandomInt(1, 1 + #_tagPool);
    return _tagPool[rndIndex];
end

--检查是否结束
function CheckIsBattleOver()
    if isRookie == 0 and curPlayerRank < 1 and curBattleScene:GetActiveUnitCount(1) <= 0 then
        FightBattleOver(false);
        return true;
    elseif curBattleScene:GetActiveUnitCount(1) <= 0 then
        if isPlayerDown or (enemyHeroesQueue.Count <= 0 and refFightersEnemy <= 0) then
            FightBattleOver(false);
            return true;
        end
    elseif curBattleScene:GetActiveUnitCount(0) <= 0 then
        if isPlayerDown or (friendHeroesQueue.Count <= 0 and refFightersFriend <= 0) then
            FightBattleOver(true);
            return true;
        end
    end
    return false;
end

function FightBattleOver(_winside)
    local tagRes = 1;
    if _winside then
        tagRes = 2;
    end
    curBattleScene:ClientExecBsCmdLines("DUNGEON_OVER*" .. tagRes, 0);
    curGameState = 2;

    if curFightType == 2 then
        --如果是比武大会获胜可在此进行额外处理
        if tagRes == 1 then
            --todo....
        end
    end
end

function ReadRoleListFromStr(_tagList, _strInfo)
    if not IsEmptyOrNil(_strInfo) then
        local tagRolesIdList = SplitStr(_strInfo, "|");
        local tagRole; 
        for k, roleID in pairs(tagRolesIdList) do
            if not IsEmptyOrNil(roleID) then
                tagRole = GameCoreHelper.GetRoleCopy(roleID);
                if tagRole ~= nil then
                    _tagList:Add(tagRole);
                end
            end
        end
    end
end