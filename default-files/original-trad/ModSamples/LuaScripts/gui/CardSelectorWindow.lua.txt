require("gui/WindowUtils")
require("GameUtils")

local GameCoreHelper = CS.GameCoreHelper

--页面访问控件
local contentPane

local btnClose;
local btnCancel;
local btnConfirm;

local txtTitle;
local allLv;
local lvHeroesList;
local lvSoldiersList;

local selCount = 1;
local defSelCard = nil;
local isEnableCancel = true;
local allCardsList;
local playerRole;

local allSelItems = nil;

local StringFormat = GameCoreHelper.StringFormat;

--窗体初始化时
function onInit()
	contentPane = self.contentPane

	playerRole = GameCoreHelper.GetPlayerRole();

	txtTitle = contentPane:GetChild("title").asTextField;

	allLv = contentPane:GetChild("party_list").asList;
	local tagComp = allLv:GetChildAt(0).asCom;
	lvHeroesList = tagComp:GetChild("items_list").asList;
	tagComp = allLv:GetChildAt(1).asCom;
	lvSoldiersList = tagComp:GetChild("items_list").asList;

	btnClose = contentPane:GetChild("btn_close").asButton;
	btnConfirm = contentPane:GetChild("btn_confirm").asButton;
	btnCancel = contentPane:GetChild("btn_cancel").asButton;

	--绑定按钮事件
	btnClose.onClick:Set(onClickBackBtn);
	btnConfirm.onClick:Set(onClickConfirmBtn);
	btnCancel.onClick:Set(onClickCancelBtn);
end

function SetWindowParams(args)
	txtTitle.text = args[0];
end

function onCustomInit()
	allCardsList = self.CustomData;
	selCount = self.CustomArgObj1;
	if selCount <= 0 then
		selCount = allCardsList.Count;
	end
	defSelCard = self.CustomArgObj2;
	isEnableCancel = self.CustomArgObj3;
	if isEnableCancel then
		btnClose.visible = false;
	else
		btnClose.visible = true;
		if IsMobileMode then
			CreateQuickCloseBg(contentPane, onClickBackBtn)
		end
	end

	UpdateCurSelectList();
end

--窗体开始显示并播放显示动画时
function onDoShowAnimation()
	CommonShowWindowAnim(self, onShown)
end

--窗体播放完显示动画时
function onShown()
	--增加计时器事件
	--CS.FairyGUI.Timers.inst:Add(timerTickInterval, 0, onTimerTickUpdate);
end

--窗体开始播放关闭动画时
function onDoHideAnimation()
	CommonHideWindowAnim(self, onHideAnimationDone)
end

function onHideAnimationDone()
	self:HideImmediately();
end

--窗体隐藏时
function onHide()
	--移除计时器事件
	--CS.FairyGUI.Timers.inst:Remove(onTimerTickUpdate);
end

--按下完成按钮时
function onClickBackBtn()
	PlayButtonSound();

	FinishSelect(nil);
	self:Hide();
end

--按下取消按钮时
function onClickCancelBtn()
	PlayButtonSound();

	FinishSelect(nil);
	self:Hide();
end

--按下完成按钮时
function onClickConfirmBtn()
	PlayButtonSound()
	if ComfirmSelect() then
		local selList = GameCoreHelper.GetEmptyCardsItemList();
		if allSelItems ~= nil then
			for k,v in pairs(allSelItems) do
				if v.isSeled and v.cardInfo ~= nil then
					selList:Add(v.cardInfo);
				end
			end
		end
		FinishSelect(selList);
		self:Hide();
	end
end

function ComfirmSelect()
	--if GetCurSeledCount() < 1 then
	--	local _alertInfo = GetGameString("lua_script_str_250");
	--	ShowToastInfo(_alertInfo, 3);
	--	return false;
    --end

	return true
end

function FinishSelect(_selList)
	local _argVal = self:GetRuntimeArgVal();
	if _argVal ~= nil then
		_argVal.customObj = _selList;
	end
end

function onTimerTickUpdate()

end

function UpdateCurSelectList()
	lvHeroesList.numItems = 0;
	lvSoldiersList.numItems = 0;

	if allCardsList == nil then
		return;
	end

	allSelItems = {};

	local tagCard;
	local tagRoleInfo;
	local tagSlotInfo;
	local defSelCardSlot = nil;
	for index=0,allCardsList.Count-1 do
		tagCard = allCardsList[index];
		tagSlotInfo = nil;
		if tagCard.cardType == 1 then
			tagRoleInfo = tagCard.BindRole;
			tagSlotInfo = AddHeroSlotViewPUI(tagRoleInfo, 0, lvHeroesList, OnClickTagCardSlot);
			UpdateHeroSlotPUI(tagSlotInfo, false);
		elseif tagCard.cardType == 0 then
			tagSlotInfo = AddSoldierSlotViewPUI(tagCard, 0, lvSoldiersList, OnClickTagCardSlot);
			UpdateSoldierSlotPUI(tagSlotInfo, false, true);
		end
		SetCardSlotSelected(tagSlotInfo, false);
		if tagSlotInfo ~= nil then
			table.insert(allSelItems, tagSlotInfo);

			if defSelCard == tagCard then
				defSelCardSlot = tagSlotInfo;
			end
		end
	end

	if defSelCardSlot ~= nil then
		SelectTagCardSlot(defSelCardSlot, true);
	end

	lvSoldiersList:ResizeToFit();
	lvHeroesList:ResizeToFit();
end

function OnClickTagCardSlot(_tagSlot)
	PlayButtonSound();

	if _tagSlot.cardInfo ~= nil then
		SelectTagCardSlot(_tagSlot, not _tagSlot.isSeled);
	end
end

function RemoveCurSelections(_removeCount)
	local curRemoveCount = 0;
	if allSelItems ~= nil then
		for k,v in pairs(allSelItems) do
			if _removeCount > 0 and curRemoveCount >= _removeCount then
				break;
			end
			if v.isSeled then
				SetCardSlotSelected(v, false);
				curRemoveCount = curRemoveCount + 1;
			end
		end
	end
end

function GetCurSeledCount()
	local curCount = 0;
	if allSelItems ~= nil then
		for k,v in pairs(allSelItems) do
			if v.isSeled then
				curCount = curCount + 1;
			end
		end
	end
	return curCount;
end

function SetCardSlotSelected(_tagSlot, _isSeled)
    if _tagSlot.selOnFrame ~= nil then
        _tagSlot.selOnFrame.visible = _isSeled;
    end
	_tagSlot.isSeled = _isSeled;
end

function SelectTagCardSlot(_tagSlot, _isSel)
	if _tagSlot == nil then
		return;
	end

	if _isSel then
		if selCount <= 1 then
			RemoveCurSelections(-1);
			SetCardSlotSelected(_tagSlot, true);
		else
			local _curCount = GetCurSeledCount();
			if _curCount >= selCount then
				RemoveCurSelections(_curCount - selCount + 1);
			end
			SetCardSlotSelected(_tagSlot, true);
		end
	else
		SetCardSlotSelected(_tagSlot, false);
	end
end
