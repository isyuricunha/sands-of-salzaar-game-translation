require("gui/WindowUtils")
require("GameUtils")
require("gui/SubWinStorySelect")
require("gui/SubWinCharCustomize")
require("gui/SubWinLagacyStore")

local GameCoreHelper = CS.GameCoreHelper

--页面访问控件
local contentPane

local compStorySel;
local ctlStorySel;

local compCharCustomize;
local ctlCharCustomize;

local compLagacyStore;
local ctlLagacyStore;

local scenePhaseCtl;
local btnsPhaseCtl;

local curScenePhase = 0;
local curBtnPhase = 0;
local txtTitle;

local btnClose;

local btnConfirm;
local btnRandom;
local btnReset;

local isSceneReady = false;

local curSeletedStory = nil;
-- 跳过捏脸
local isSkipAvataVal = 0;

---@type UINavigableObject
local navObjStories;

--窗体初始化时
function onInit()
	contentPane = self.contentPane

	local groupTop = contentPane:GetChild("g_top").asGroup;
	txtTitle = contentPane:GetChildInGroup(groupTop, "title").asTextField;

	compStorySel = contentPane:GetChild("story_sel").asCom;
	compCharCustomize = contentPane:GetChild("char_custom").asCom;
	compLagacyStore = contentPane:GetChild("legacy_store").asCom;

	scenePhaseCtl = contentPane:GetController("scene_phase");
	btnsPhaseCtl = contentPane:GetController("btn_states");

	local groupBottom = contentPane:GetChild("g_bottom").asGroup;
	btnConfirm = contentPane:GetChildInGroup(groupBottom, "btn_confirm").asButton;
	btnRandom = contentPane:GetChildInGroup(groupBottom, "btn_random").asButton;
	btnReset = contentPane:GetChildInGroup(groupBottom, "btn_reset").asButton;

	btnClose = contentPane:GetChild("btn_close").asButton;

	btnConfirm.onClick:Add(onClickConfirmBtn);
	btnRandom.onClick:Add(onClickRandomBtn);
	btnReset.onClick:Add(onClickResetBtn);

	btnClose.onClick:Add(onClickBackBtn);

	--初始化变量
	ctlStorySel = SubWinStorySelect:Create(compStorySel, function()
		TryLeaveCreateGame();
	end);

	ctlCharCustomize = SubWinCharCustomize:Create(compCharCustomize, function()
		SwitchScenePhase(0);
	end);
	ctlCharCustomize.ResetBtnPhaseCallback = function(_btnPhase)
		if _btnPhase == 0 then
			SwitchBtnPhase(2);
		end
	end;

	ctlLagacyStore = SubWinLagacyStore:Create(compLagacyStore, function()
        if (isSkipAvataVal == 1) then
			SwitchScenePhase(0);
        else
            SwitchScenePhase(1);
		end
	end);

	self:SetBackkeyButton(btnClose);

	scenePhaseCtl.selectedIndex = 0;
	btnsPhaseCtl.selectedIndex = 0;

	InitNavCtl()

	isSceneReady = false;
end

function InitNavCtl()
	---@type UINavigationController
	local navCtl = self:GetOrCreateNavCtl();
	navObjStories = navCtl:AddNavObjSubSpace()
	local navCtlStories = navObjStories.subNavSpace

	---@type UINavigableObject
	local leftObj
	local firstObj
	for i = 0, ctlStorySel.listStorys.numItems - 1 do
		local slot = ctlStorySel.curSlots[i]
		local curObj = navCtlStories:AddNavObjByGButton(slot.bindBtn)
			:SetFocusEventCallback(function()
				ctlStorySel.listStorys:ScrollToView(i)
				ctlStorySel:SelectStoryCard(slot)
			end)
		if leftObj ~= nil then
			curObj:SetNavLeft(leftObj)
		end
		if firstObj == nil then
			firstObj = curObj
		end
		leftObj = curObj
	end

	self:RegJoystickQuickButton(btnConfirm, JoystickButton.ButtonA, false);

	navCtl:SetDefaultFocus(navObjStories)
end

function TryLeaveCreateGame()
	local _confirmInfo = GetGameString("lua_script_str_260");
	ShowConfirmDlg(_confirmInfo, "yesno", function(ret)
		if ret == 1 then
			self:Hide();
			--返回主界面
			CS.GUIHelper.SwitchToHomeScene();
		end
	end)
end

--窗体开始显示并播放显示动画时
function onDoShowAnimation()
	self:MakeFullScreen();
	self:Center();
	CommonShowWindowAnim(self, onShown)
end

--窗体播放完显示动画时
function onShown()
	isSceneReady = true;

	--播放BGM
	CS.AudioManager.Instance:PlayMusic("@传说");
end

--窗体开始播放关闭动画时
function onDoHideAnimation()
	CommonHideWindowAnim(self, onHideAnimationDone)
end

function onHideAnimationDone()
	self:HideImmediately();
end

--窗体隐藏时
function onHide()

end

function ShowAlertInfo(_msg, type)
	local toastInfo = "";
	if type == 1 then
		toastInfo = toastInfo .. "[[red:"
	else
		toastInfo = toastInfo .. "[[white:"
	end
	toastInfo = toastInfo .. _msg .. "]]";
	ShowToastInfo(toastInfo, 2);
end

function onClickBackBtn()
	if not isSceneReady then
		return;
	end
	if curScenePhase == 0 then
		ctlStorySel:onClickBackBtn();
	elseif curScenePhase == 1 then
		ctlCharCustomize:onClickBackBtn();
	elseif curScenePhase == 2 then
        ctlLagacyStore:onClickBackBtn();
	end
end

function onClickConfirmBtn()
	PlayButtonSound()

	beforeLeaveScene();
	if curScenePhase == 0 then
		if ctlStorySel.curSeledStory == nil then
			ShowToastInfo(GetGameString("lua_script_str_156"), 3);
			return;
		end
		curSeletedStory = ctlStorySel.curSeledStory;
		if not GameCoreHelper.CheckConditionGroup(curSeletedStory.Condition, nil, false) then
			ShowToastInfo(GetGameString("UIPageStoryMode_Confirm_1"), 3);
			return;
		end
		--存储临时变量
		CS.GameShared.Instance.curEditedStoryModeId = curSeletedStory.ModeId;
		local curSeledAvataInfo = curSeletedStory:GetStoryDefAvataInfo();
		local defRoleGender = 0;
		if curSeletedStory:GetStoryDefAvataGender() then
			defRoleGender = 1;
		end
		local isFixedNameVal = 0;
		local fixedDefName = "";
		if curSeletedStory:IsFixedName() then
			isFixedNameVal = 1;
			fixedDefName = curSeletedStory:GetDisplayName();
		end
		isSkipAvataVal = 0;
		if curSeletedStory:IsSkilpAvata() then
			isSkipAvataVal = 1;
			fixedDefName = curSeletedStory:GetDisplayName();
		end
		local defModelID = curSeletedStory.DefaultModelInfo;

		local genderLimitMode = curSeletedStory.SexLimit;
		if genderLimitMode >= 0 and genderLimitMode <= 1 then
			defRoleGender = genderLimitMode;
		end

		CS.GUIHelper.SetGUIGlobalStrVal("cur_story_id", curSeletedStory.ModeId);
		CS.GUIHelper.SetGUIGlobalStrVal("def_avata_info", curSeledAvataInfo);
		CS.GUIHelper.SetGUIGlobalIntVal("def_avata_gender", defRoleGender);
		CS.GUIHelper.SetGUIGlobalIntVal("is_fixed_name", isFixedNameVal);
		CS.GUIHelper.SetGUIGlobalStrVal("def_player_name", fixedDefName);
		CS.GUIHelper.SetGUIGlobalStrVal("def_player_model", defModelID);
		CS.GUIHelper.SetGUIGlobalIntVal("gender_limit_mode", genderLimitMode);

		if isSkipAvataVal == 1 then
			--直接跳到传承界面
			CS.GUIHelper.SetGUIGlobalStrVal("edit_avata_info", curSeledAvataInfo);
			CS.GUIHelper.SetGUIGlobalIntVal("edit_avata_gender", defRoleGender);
			CS.GUIHelper.SetGUIGlobalStrVal("edit_player_name", fixedDefName);
			CS.GUIHelper.SetGUIGlobalStrVal("edit_model_info", defModelID);
			SwitchScenePhase(2);
		else
			--跳至捏脸界面
			SwitchScenePhase(1);
		end
	elseif curScenePhase == 1 then
		if not ctlCharCustomize:TryConfirmCurEdit() then
			return;
		end
		if not ctlCharCustomize:GotoNextStep() then
			SwitchScenePhase(2);
		else
			if ctlCharCustomize.curCustomizePhase == 1 then
				SwitchBtnPhase(0);
			else
				SwitchBtnPhase(2);
			end
		end
	elseif curScenePhase == 2 then
		if not ctlLagacyStore.isSceneReady then
			return;
		end
		if not ctlLagacyStore:TryConfirmCurEdit() then
			return;
		end

		--正式进入游戏
		startLuanchGame();
	end
end

function startLuanchGame()
	local curEditAvataInfo = CS.GUIHelper.GetGUIGlobalStrVal("edit_avata_info");
	local curEditAvataGender = CS.GUIHelper.GetGUIGlobalIntVal("edit_avata_gender") == 1;
	local curEditAvataName = CS.GUIHelper.GetGUIGlobalStrVal("edit_player_name");
	local curEditModelInfo = CS.GUIHelper.GetGUIGlobalStrVal("edit_model_info");

	local isExpertMode = CS.GUIHelper.GetGUIGlobalIntVal("newgame_is_expert");
	local curGameMode = CS.GUIHelper.GetGUIGlobalIntVal("newgame_gamemode_code");
	local curHardlevel = CS.GUIHelper.GetGUIGlobalIntVal("newgame_hardlevel_code");

	if curGameMode == 1 then
		CS.GameTools.AddGameInitCmds("SETINTVAR*system_沙盒模式#1");
	else
		CS.GameTools.AddGameInitCmds("SETINTVAR*system_沙盒模式#0");
	end

	--埋点统计
	GameCoreHelper.TrackEvent("game_schema", "game_schema_key=" .. curGameMode);

	--根据难度创建初始指令表
	AddInitCmdsByHardLevel(curHardlevel);

	CS.GameTools.StartPlayGame(curEditAvataName, curEditAvataGender, curEditAvataInfo, "", curEditModelInfo);
	CS.HanFramework.ArchiveData.Current.IsExpertModeCode = isExpertMode;
	CS.HanFramework.ArchiveData.Current.PlayerClass = CS.GameShared.Instance.curEditedStoryModeId;
end

function onClickRandomBtn()
	PlayButtonSound()

	if curScenePhase == 1 then
		ctlCharCustomize:OnClickRndAvataBtn();
	end
end

function onClickResetBtn()
	PlayButtonSound()

	if curScenePhase == 2 then
		ctlLagacyStore:ResetAllItems();
	end
end

function beforeLeaveScene()
	CS.GUIHelper.CloseAllPopupWindow()
end

function SetTitle(_title)
	txtTitle.text = _title;
end

function SwitchScenePhase(_newPhase)
	if curScenePhase ~= _newPhase then
		curScenePhase = _newPhase;
		if curScenePhase == 1 then
			ctlCharCustomize:ShowUpScene();
			SwitchBtnPhase(2);
		elseif curScenePhase == 2 then
			ctlLagacyStore:ShowUpScene();
			SwitchBtnPhase(1);
		else
			SwitchBtnPhase(0);
			curScenePhase = 0;
		end
		scenePhaseCtl.selectedIndex = curScenePhase;
	end
end

function SwitchBtnPhase(_newPhase)
	curBtnPhase = _newPhase;
	btnsPhaseCtl.selectedIndex = curBtnPhase;
end
