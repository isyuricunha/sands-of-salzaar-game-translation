--require("LuaPanda").start("127.0.0.1",8818)

require("RemoteShopLogic")
require("GameMath")

curBattleScene = nil

playerUnitDefeatCount = 0

playerUnitID = 0

playerUnit = nil
playerRole = nil
playerCurLevel = 1
playerCount = 1
mapLevel = 1
defenceWave = 0

curPlayerInfo = nil
playerActorID = 0

totalPlayerGainedSp = 1
totalPlayerUsedSp = 0

MyRole = nil
actionBarSlotCount = 4

RES_ID_MONEY = "金钱"
--默认的游戏模式
GameMode = "Normal"
--游戏模式类型
GameModeTable = {
    "Normal",--通常模式：击败指定数量的怪物后出现BOSS
    "Race",--竞速模式：在指定时间内，激活特定数量的仪式石柱召唤BOSS，超时将不断损失生命
    "Defence"--防守模式：出生点具有玩家大本营，会有一波波的敌人刷出向大本营发动进攻
}
local GameCoreHelper = CS.GameCoreHelper
local GameTools = CS.GameTools
local isRemoteHost = false
local selRoleWindow = nil
local curRemoteShopWindow = nil

MonsterCount = 0

local isNeedRecover = true

local isStartDetecte = false
local isGameFinished = false

BossTable = {"天之圣骑","女武神","鱼人大巫师","烈焰魔灵","旧神信徒"}

--场景初始化
function initBattleScene(_bs)
    curBattleScene = _bs
    curPlayerInfo = curBattleScene:GetCurPlayerInfo()
    playerActorID = curPlayerInfo.actorID
    isRemoteHost = not curBattleScene.isRemoteClient
    isStartDetecte = false
    if curBattleScene:GetDungeonIntVal("自定义初始化主角") <= 0 then
        local newWindow = CS.GUIHelper.ShowGUIWindow("MyGUI", "SelectRoleWindow", "MySelectRoleWindow", "", onSelRoleDlgCallback)
        newWindow:SetBattleScene(curBattleScene)
        newWindow:SetWindowParams("testArg1", "testArg2")
        selRoleWindow = newWindow

        curBattleScene:SetDungeonIntVal("自定义初始化主角", 1)
    else
        curBattleScene:SendUIMessage("player_inited", "1")
    end
    playerCount = curBattleScene:GetAllPlayersInBattle().Count
    --设定地图等级
    if(curBattleScene:GetDungeonIntVal("LEVEL") > 1)then
        mapLevel = curBattleScene:GetDungeonIntVal("LEVEL")
    end
    if(curBattleScene:GetDungeonStrVal("MyRole") ~= nil and curBattleScene:GetDungeonStrVal("MyRole") ~= "")then
        MyRole = curBattleScene:GetDungeonStrVal("MyRole")
    end
    if(GameCoreHelper.GetPlayerRole() ~= nil and curBattleScene:GetDungeonIntVal("MONEY") > 0)then
        GameCoreHelper.GetPlayerRole():ChangeResourceNum(RES_ID_MONEY, curBattleScene:GetDungeonIntVal("MONEY")-300, false, 1)
    end
    if(GameCoreHelper.GetPlayerRole() ~= nil)then
        playerCurLevel = GameCoreHelper.GetPlayerRole().roleLevel
    end
    --先初始化一下游戏的模式
    --InitGameMode()
    MonsterCount = 0
    --判定当前地图，不同的地图执行不同的逻辑
    if curBattleScene:IsHostClient() then
        curBattleScene:SetRemoteGameVal("refresh_shop_times", 1, onInitRefreshShopCallback)
        if (curBattleScene:GetDungeonMapID() == "红石山谷") then
            InitMapMonsters()
            InitMapObjects()
            InitTreasureBox()
            InitGameModeText()
        elseif (curBattleScene:GetDungeonMapID() == "花卉密林") then
            InitMapObjectsAndTreasure()
        elseif (curBattleScene:GetDungeonMapID() == "风哭岩道") then
            InitMapObjectsAndTreasure()
            InitGameModeText()
        elseif (curBattleScene:GetDungeonMapID() == "环形红石山谷") then
            InitMapObjectsNew("交互区域")
            for i=1, playerCount do
                SpawnEnemy("刷怪区域1")
            end
        elseif (curBattleScene:GetDungeonMapID() == "风哭岩道环形") then
            InitGameMode()
            InitMapObjectsNew("交互区域")
            FakeMeSaySoMuch()
        elseif (curBattleScene:GetDungeonMapID() == "骆驼城之路") then
            InitGameMode()
            InitMapObjectsNew("交互区域")
            AIInit()
        elseif (curBattleScene:GetDungeonMapID() == "风哭岩道环形2") then
            InitGameMode()
            InitMapObjectsNew("交互区域")
            FakeMeSaySoMuch()
        elseif (curBattleScene:GetDungeonMapID() == "骆驼城之路2") then
            InitGameMode()
            InitMapObjectsNew("交互区域")
            AIInit()
        end
        --主机初始化刷新商店
        InitRemoteShop(curBattleScene)
    else
        --客机商店设置
        SetRemoteShopScene(curBattleScene)
    end
    InitShopButton()
end

function AIInit()
    CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text1") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text2") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    InitGameModeText()
end

function FakeMeSaySoMuch()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text3") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text4") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text5") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text6") .. "#0"
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
    InitGameModeText()
end

function FakeMeSay1()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text7") .. "#0"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    CMD = "EVENT*环形红石山谷进度2_1"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function FakeMeSay2()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text8") .. "#0"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    CMD = "EVENT*环形红石山谷进度3_1"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function FakeMeSay3()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text9") .. "#0"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    CMD = "EVENT*环形红石山谷进度3_2"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function FakeMeSay4()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text10") .. "#0"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    CMD = "EVENT*环形红石山谷进度6_1"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function FakeMeSay5()
    local CMD = "BB*" .. MyRole .. "#" .. GetGameString("MG1_Cmd_Dialog_Text11") .. "#0"
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function onSelRoleDlgCallback(ret)
    selRoleWindow = nil
    if curBattleScene:IsHostClient() then
        local CMD = "EVENT*环形红石山谷初始引子"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function onSetGameModeCallback(ret)
    -- body
end

function InitGameMode()
    if curBattleScene:IsHostClient() then
        if(curBattleScene:GetDungeonStrVal("LastMode") == "Race")then
            GameMode = "Defence"
        elseif(curBattleScene:GetDungeonStrVal("LastMode") == "Defence")then
            GameMode = "Race"
        elseif(GameCoreHelper.GetRandomInt(1,3) == 1)then
            GameMode = "Race"
        else
            GameMode = "Defence"
        end
        curBattleScene:SetRemoteGameVal("game_mode", GameMode, onSetGameModeCallback)
        curBattleScene:SetDungeonStrVal("LastMode", GameMode)
    end
end

function InitGameModeText()
    if(GameMode == "Normal")then
        local CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text12") .. "#0"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
        CMD = "EVENT*风哭岩道进度初始化Normal计时"
        curBattleScene:LocalExecBsCmdLines(CMD, 0)
    elseif(GameMode == "Race")then
        local CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text13") .. "#0"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
        CMD = "EVENT*风哭岩道进度初始化Race计时"
        curBattleScene:LocalExecBsCmdLines(CMD, 0)
        InitRaceMode()
    elseif(GameMode == "Defence")then
        local CMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text14") .. "#0"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
        CMD = "EVENT*风哭岩道进度初始化Defence计时"
        curBattleScene:LocalExecBsCmdLines(CMD, 0)
    end
end

function GetTrigger(_type)
    local triggerID = ""
    local dLevel = 2
    if(curBattleScene:GetRemoteGameVal("global_difficulty") ~= "")then
        dLevel = tonumber(curBattleScene:GetRemoteGameVal("global_difficulty"))
    end
    local hpRate = 0
    local dmgRate = 0
    local decRate = 0
    local weakRate = 0
    local specialID = ""
    --多人模式血量加成，1个人100%，2个人150%，3个人175%，4个人200%
    local multiHpRate = 1 + 0.5 * math.min(1, playerCount - 1) + 0.25 * math.max(0, playerCount - 2)
    --多人模式BOSS血量加成，1个人100%，2个人175%，3个人250%，4个人400%
    local multiHpRateBoss = 1 + 0.75 * (playerCount - 1) + 0.75 * math.max(0, playerCount - 3)
    --难度下血量加成
    local hardHpRate = 0.5 + math.max(0, dLevel - 2) * 0.4 + math.max(0, dLevel - 3) * 0.4 +  math.max(0, dLevel - 4) * 0.5
    --难度下伤害加成
    local hardDmgRate = 1
    if(dLevel == 3)then
        hardDmgRate = 1.5
    elseif(dLevel == 4)then
        hardDmgRate = 1.75
    elseif(dLevel == 5)then
        hardDmgRate = 2
    end
    --低难度伤害惩罚
    decRate = 25 * math.max(0, 3 - dLevel)
    --低难度受伤惩罚
    weakRate = 50 * math.max(0, 2 - dLevel)
    --开始按类型检索
    if(_type == "Boss")then
        specialID = triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
        --首领需要一个特殊的血量加成，随等级快速提升
        local hpAdjust1 = math.max(playerCurLevel - 6,0) * 100
        local hpAdjust2 = math.max(playerCurLevel - 11,0) * 125
        local hpAdjust3 = math.max(playerCurLevel - 16,0) * 150
        local hpAdjust = hpAdjust1 + hpAdjust2 + hpAdjust3
        hpRate = math.ceil(((playerCurLevel-1) * 50 + hpAdjust)* multiHpRateBoss * hardHpRate * 1.5)
        dmgRate = math.ceil(playerCurLevel * 9 * hardDmgRate)
    elseif(_type == "EliteMelee")then
        specialID = triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
        hpRate = math.ceil((playerCurLevel-1) * 16 * multiHpRate * hardHpRate)
        dmgRate = math.ceil(playerCurLevel * 7 * hardDmgRate)
    elseif(_type == "EliteRange")then
        specialID = triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
        hpRate = math.ceil((playerCurLevel-1) * 8 * multiHpRate * hardHpRate)
        dmgRate = math.ceil(playerCurLevel * 9 * hardDmgRate)
    elseif(_type == "EliteMagic")then
        specialID = triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
        hpRate = math.ceil((playerCurLevel-1) * 12 * multiHpRate * hardHpRate)
        dmgRate = math.ceil(playerCurLevel * 7 * hardDmgRate)
    elseif(_type == "DefenceBoss")then
        specialID = triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
        local hpAdjust1 = math.max(playerCurLevel - 6,0) * 100
        local hpAdjust2 = math.max(playerCurLevel - 11,0) * 125
        local hpAdjust3 = math.max(playerCurLevel - 16,0) * 150
        local hpAdjust = hpAdjust1 + hpAdjust2 + hpAdjust3
        hpRate = math.ceil(((playerCurLevel-1) * 75 + hpAdjust)* multiHpRateBoss * hardHpRate * 1.5)
        dmgRate = math.ceil(playerCurLevel * 9 * hardDmgRate)
    elseif(_type == "Melee")then
        hpRate = math.ceil((playerCurLevel-1) * 6 * multiHpRate * hardHpRate * 0.5)
        dmgRate = math.ceil(playerCurLevel * 3 * hardDmgRate)
    elseif(_type == "Range")then
        hpRate = math.ceil((playerCurLevel-1) * 2.5 * multiHpRate * hardHpRate* 0.5)
        dmgRate = math.ceil(playerCurLevel * 5 * hardDmgRate)
    else
        hpRate = math.ceil((playerCurLevel-1) * 6 * multiHpRate * hardHpRate* 0.5)
        dmgRate = math.ceil(playerCurLevel * 3 * hardDmgRate)
    end
    local status = GameTools:GetRoleLevelBaseStatu(playerCurLevel);
    local hpAdd = math.floor(status:getVal("s_生命") * hpRate/100)
    triggerID = "s_生命," .. hpAdd .. "|" .. "pup_全部," .. dmgRate .. "|" .. "dbf_虚弱," .. decRate .. "|" .. "udatk_受伤加深," .. weakRate
    if(specialID ~= "")then
        triggerID = triggerID .. "|" .. specialID
    end

    return triggerID
end

function SpawnDefenceEnemyElite()
    local eliteCount = 1 + playerCount + (defenceWave-1) * playerCount
    local _level = playerCurLevel
    if(_level <= 1)then
        _level = mapLevel
    end
    for s=0,eliteCount do
        local enemyTable = eliteTable[GameCoreHelper.GetRandomInt(1, #eliteTable+1)]
        local enemyID = enemyTable[1]
        local triggerID = GetTrigger(enemyTable[2])
        local defpos = "-1731,-6240"
        if (curBattleScene:GetDungeonMapID() == "风哭岩道环形" or curBattleScene:GetDungeonMapID() == "风哭岩道环形2" ) then
            defpos =  "-25,-9640"
        end
        local tagCmd = "AREA_SPAWN*塔防出怪区域1#防御" .. enemyID .. "," .. tostring(_level) .. "##1#3:" .. defpos .. "#DEFENCE敌人#" .. triggerID
        curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
    end
end

function SpawnDefenceEnemy()
    defenceWave = defenceWave + 1
    local enemyCount = 12 + (10 + 5 * (defenceWave-1)) * playerCount
    local totalEnemyCount = enemyCount
    local _level = playerCurLevel + 2
    if(_level <= 3)then
        _level = mapLevel + 2
    end
    --每次刷3种近战怪和2种远程怪
    local soldierStr1 = ""
    local soldierStr2 = ""
    for i=1,3 do
        local tagTable = meleeEnemyTable
        local tobeRandomedTable = {}
        local tobeRandomedTableIndex = 0
        for k,v in pairs(tagTable) do
            if(tonumber(k) <= tonumber(_level))then
                tobeRandomedTable[tobeRandomedTableIndex] = tonumber(k)
                tobeRandomedTableIndex = tobeRandomedTableIndex + 1
            end
        end
        local randomIndex = 1
        if(#tobeRandomedTable > 0)then
            randomIndex = GetRandomTableByWeight(tobeRandomedTable)[1].index
        end
        local enemyTable = tagTable[randomIndex]
        local enemyId = "防御" .. enemyTable[GameCoreHelper.GetRandomInt(1,#enemyTable+1)]
        local Count =  GameCoreHelper.GetRandomInt(math.ceil(enemyCount/10),math.ceil(enemyCount/5))
        totalEnemyCount = totalEnemyCount - Count
        if(i == 1)then
            soldierStr1 = enemyId .. "," .. Count .. "," .. Count .. "," .. tostring(_level - 2)
        else
            soldierStr1 = soldierStr1 .. "|" .. enemyId .. "," .. Count .. "," .. Count .. "," .. tostring(_level - 2)
        end
    end
    for j=1,2 do
        local tagTable = rangeEnemyTable
        local tobeRandomedTable = {}
        local tobeRandomedTableIndex = 0
        for k,v in pairs(tagTable) do
            if(tonumber(k) <= tonumber(_level))then
                tobeRandomedTable[tobeRandomedTableIndex] = tonumber(k)
                tobeRandomedTableIndex = tobeRandomedTableIndex + 1
            end
        end
        local randomIndex = 1
        if(#tobeRandomedTable > 0)then
            randomIndex = GetRandomTableByWeight(tobeRandomedTable)[1].index
        end
        local enemyTable = tagTable[randomIndex]
        local enemyId = "防御" .. enemyTable[GameCoreHelper.GetRandomInt(1,#enemyTable+1)]
        local Count = 1
        if(j < 2)then
            Count = GameCoreHelper.GetRandomInt(math.ceil(enemyCount/10),math.ceil(enemyCount/5))
            totalEnemyCount = totalEnemyCount - Count
        else
            Count = totalEnemyCount
            if(Count <= 0)then Count = 1 end
        end
        if(j == 1)then
            soldierStr2 = enemyId .. "," .. Count .. "," .. Count .. "," .. tostring(_level - 2)
        else
            soldierStr2 = soldierStr2 .. "|" .. enemyId .. "," .. Count .. "," .. Count .. "," .. tostring(_level - 2)
        end
    end

    local triggerID1 = GetTrigger("Melee")
    local triggerID2 = GetTrigger("Range")
    local defpos = "-1731,-6240"
    if (curBattleScene:GetDungeonMapID() == "风哭岩道环形" or curBattleScene:GetDungeonMapID() == "风哭岩道环形2" ) then
        defpos =  "-25,-9640"
    end
    local CMD = "AREA_SPAWN*塔防出怪区域1##".. soldierStr1 .."#1#3:" .. defpos .. "#DEFENCE敌人1#" .. triggerID1
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    CMD = "AREA_SPAWN*塔防出怪区域1##".. soldierStr2 .."#1#3:" .. defpos .. "#DEFENCE敌人2#" .. triggerID2
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
    local EliteCMD = "SET_TIMER*精英刷怪#60#风哭岩道塔防刷怪精英"
    curBattleScene:LocalExecBsCmdLines(EliteCMD, 0)

    --主机才通知全体执行，客机不执行，否则会触发playerCount次事件
    if curBattleScene:IsHostClient() then
        local money = 150 + defenceWave * 100
        local bonusCMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text16") .. "#0"
        curBattleScene:ClientExecBsCmdLines(bonusCMD, 0)
        bonusCMD = "GETITEMS*金钱," .. tostring(money)
        curBattleScene:ClientExecBsCmdLines(bonusCMD, 0)
        local resource = math.ceil(defenceWave/2) + 3
        bonusCMD = "SET_DG_INTVAR*个人资源点#" .. resource .. "#1#" .. GetGameString("MG1_Cmd_Dialog_Text17")
        curBattleScene:ClientExecBsCmdLines(bonusCMD, 0)
        local bonusCMD = "TOAST*" .. GetGameString("MG1_Cmd_Dialog_Text18")
        curBattleScene:ClientExecBsCmdLines(bonusCMD, 0)
        local bonusCMD = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text19") .. "#0"
        curBattleScene:ClientExecBsCmdLines(bonusCMD, 0)
    end
end

function SpawnDefenceEnemyBOSS()
    SpawnDefenceEnemy()
    local EliteCMD = "SET_TIMER*BOSS刷怪#70#风哭岩道塔防刷怪BOSS出现"
    curBattleScene:LocalExecBsCmdLines(EliteCMD, 0)
end

function SpawnDefenceEnemyBOSS2()
    local _level = playerCurLevel
    if(_level <= 1)then
        _level = mapLevel
    end
    local triggerID = GetTrigger("DefenceBoss")
    local defpos = "-1731,-6240"
    if (curBattleScene:GetDungeonMapID() == "风哭岩道环形" or curBattleScene:GetDungeonMapID() == "风哭岩道环形2" ) then
        defpos =  "-25,-9640"
    end
    local BossId = BossTable[GameCoreHelper.GetRandomInt(1,#BossTable+1)]
    local tagCmd = "AREA_SPAWN*塔防出怪区域1#" .. BossId .. "," .. tostring(_level) .. "##1#3:" .. defpos .. "#BOSS刷出#" .. triggerID
    curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
end

function InitDefenceMode()
    local hpRate = math.ceil(playerCurLevel * (5 + playerCount)) * 5
    local status = GameTools:GetRoleLevelBaseStatu(playerCurLevel);
    local hpAdd = math.floor(status:getVal("s_生命") * hpRate/100)
    local triggerID = "s_生命," .. hpAdd
    local CMD = "AREA_SPAWN*基地区域#信标," .. tostring(mapLevel+1) .."##0#1:3000#基地#" .. triggerID
    curBattleScene:LocalExecBsCmdLines(CMD, 0)

    local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains("防御塔区域")
    for i=0,tagAreasPool.Count-1 do
        local tagArea = tagAreasPool[i]
        local x = tagArea.centerPos.x
        local y = tagArea.centerPos.y
        local locationPos = curBattleScene:GetMapPosByRealPos(x, y)
        local location = locationPos.x .. "," .. locationPos.y
        CMD = "ADD_INTER_OBJECT*" .. GetGameString("MG1_Cmd_Dialog_Text21") .. "#".. location .. "#马车022#马车02#psChestFlash1,0,0#0#" .. tagArea.controlID .. "##OL建造防御塔#2"
        curBattleScene:LocalExecBsCmdLines(CMD, 0)
    end
end

function BuildTowerNormal()
    local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains("防御塔区域")
    local tagTable = SortTableByDistance(tagAreasPool)
    if(tagTable ~= nil)then
        local tagAreaID = tagTable[1].id
        local level = 0
        if(playerCurLevel == 1)then
            level = mapLevel
        else
            level = playerCurLevel
        end
        local CMD = "AREA_SPAWN*" .. tagAreaID .. "#弓箭塔1,".. tostring(level) .."##0#1:5000#防御塔#"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function BuildTowerThree()
    local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains("防御塔区域")
    local tagTable = SortTableByDistance(tagAreasPool)
    if(tagTable ~= nil)then
        local tagAreaID = tagTable[1].id
        local level = 0
        if(playerCurLevel == 1)then
            level = mapLevel
        else
            level = playerCurLevel
        end
        local CMD = "AREA_SPAWN*" .. tagAreaID .. "#弓箭塔2,".. tostring(level) .."##0#1:5000#防御塔#"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function BuildTowerStun()
    local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains("防御塔区域")
    local tagTable = SortTableByDistance(tagAreasPool)
    if(tagTable ~= nil)then
        local tagAreaID = tagTable[1].id
        local level = 0
        if(playerCurLevel == 1)then
            level = mapLevel
        else
            level = playerCurLevel
        end
        local CMD = "AREA_SPAWN*" .. tagAreaID .. "#弓箭塔3,".. tostring(level) .."##0#1:5000#防御塔#"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function BuildTowerIce()
    local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains("防御塔区域")
    local tagTable = SortTableByDistance(tagAreasPool)
    if(tagTable ~= nil)then
        local tagAreaID = tagTable[1].id
        local level = 0
        if(playerCurLevel == 1)then
            level = mapLevel
        else
            level = playerCurLevel
        end
        local CMD = "AREA_SPAWN*" .. tagAreaID .. "#巫师塔1,".. tostring(level) .."##0#1:5000#防御塔#"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function InitRaceMode()
    for i=1,4 do
        local ctlID = "祭坛区域" .. i
        local tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains(ctlID)
        local tagArea = tagAreasPool[GameCoreHelper.GetRandomInt(0,tagAreasPool.Count)]
        local x = tagArea.centerPos.x
        local y = tagArea.centerPos.y
        local locationPos = curBattleScene:GetMapPosByRealPos(x, y)
        local location = locationPos.x .. "," .. locationPos.y
        local CMD = "ADD_INTER_OBJECT*" .. GetGameString("MG1_Cmd_Dialog_Text22") .. "#" .. location .. "#ol任务建筑1#ol任务建筑1完成#psChestFlash1,0,0#0#任务" .. i .. "##OL祭祀仪式柱#2"
        curBattleScene:ClientExecBsCmdLines(CMD, 0)
    end
end

function RandomTableElementWithCount(_table,_count)
    local newTable = {}
    for k,v in ipairs(_table) do
        table.insert(newTable, {id = k, num = GameCoreHelper.GetRandomNum(1,100)})
    end
    table.sort(newTable, function(a,b) return a.num<b.num end)

    local finalTable = {}
    for i=1, _count do
        table.insert(finalTable, _table[newTable[i].id])
    end
    return finalTable
end

function onGameStart()
    --初始化游戏事件
end

function onSeledPlayerRole(tagPlayer, templateRoleID)
    if not isRemoteHost then
        return
    end
    if tagPlayer == nil then
        return
    end

    local tagSide = 0
    local randomInt = GameCoreHelper.GetRandomInt(-50,50)
    local unitPosX = 0
    local unitPosY = 0
    if (curBattleScene:GetDungeonMapID() == "环形红石山谷") then
        unitPosX = curBattleScene:GetBattleRealPosByMapPos(-964,-3717).x
        unitPosY = curBattleScene:GetBattleRealPosByMapPos(-964,-3717).y
    end
    local initDir = 235
    curBattleScene:SetPlayerUnit(tagPlayer.actorID, templateRoleID, tagSide, unitPosX+randomInt, unitPosY+randomInt, initDir)
end

--销毁场景接口
function onBattleSceneDestory()

end

--场景事件
function onSceneEvent(_eventType, _eventArg)
    if _eventType == "on_teleport" then
        --此事件中_eventArg为目标的副本地图ID
        --保存本地的技能信息
        SaveSkillInfos()
    elseif _eventType == "roominfo_updated" then
        onRoomInfoUpdate()
    end
end

local playerSelRolesDic = {}
--尝试设置游戏全局变量值接口（只会在主机端生效 成功返回0  失败返回1
function trySetRemoteVal(_key, _val)
    if _key == "player_sel_role" then
        local nFindIndex = string.find(_val, "#", 0)
        if nFindIndex > 0 then
            local tagRoleID = string.sub(_val, 0, nFindIndex - 1)
            local tagPlayerID = string.sub(_val, nFindIndex + 1, string.len(_val))
            if playerSelRolesDic[tagRoleID] ~= nil then
                return 1
            end
        end
    elseif _key == "try_buy" then
        if not RequestBuyItemByGID(_val) then
            return 1
        end
    elseif _key == "try_sell" then
        if not RequestSellOutItem(_val) then
            return 1
        end
    elseif _key == "refresh_shop_times" then
        RefreshShopGoods()
    end
    return 0
end

--房间信息改变或者玩家状态信息改变事件处理
function onRoomInfoUpdate()

end

--全局变量值更新接口
function onRemoteValUpdate(_key, _val)
    if _key == "player_sel_role" then
        local nFindIndex = string.find(_val, "#", 0)
        if nFindIndex > 0 then
            local tagRoleID = string.sub(_val, 0, nFindIndex - 1)
            local tagPlayerID = string.sub(_val, nFindIndex + 1, string.len(_val))
            --还原旧的选择
            for _roleID, _tagPlayerID in pairs(playerSelRolesDic) do
                if _tagPlayerID == tagPlayerID then
                    playerSelRolesDic[_roleID] = nil
                end
            end
            playerSelRolesDic[tagRoleID] = tagPlayerID
            --更新选人界面
            if selRoleWindow ~= nil then
                selRoleWindow:OnWindowEvent("player_sel_role", tagRoleID .. "#" .. tagPlayerID)
            end
        end
    elseif (_key == "on_set_difficulty") then
        if selRoleWindow ~= nil then
            selRoleWindow:OnWindowEvent("on_set_difficulty", _val)
        end
    elseif (_key == "global_difficulty") then
        if selRoleWindow ~= nil then
            selRoleWindow:OnWindowEvent("global_difficulty", _val)
        end
    elseif _key == "shop_items_info" then
        --更新商店界面
        if curRemoteShopWindow ~= nil then
            curRemoteShopWindow:OnWindowEvent("shop_updated", _val)
        end
    elseif _key == "game_mode" then
        GameMode = _val
    end
end

--联机自定义事件
function onRemoteEvent(_eventType, _eventArg, _callerPlayer)
    if _eventType == "seled_player" then
        --自定义选定角色模板事件
        if isRemoteHost and _callerPlayer ~= nil then
            onSeledPlayerRole(_callerPlayer, _eventArg)
        end
    end
end

--单位事件
function onUnitEvent(_tagUnit, _eventType, _eventArg)
    if _eventType == "set_player" then
        --设置玩家控制单位事件
        onSetPlayerUnit(_tagUnit)
    elseif _eventType == "level_changed" then
        --单位等级发生改变事件
        onUnitLevelChanged(_tagUnit, tonumber(_eventArg))
    elseif _eventType == "on_die" then
        --单位被击倒事件
        onUnitDie(_tagUnit)
    end
end

--场景每秒事件
function onSecondUpdate()
    if curBattleScene:IsHostClient() then
        if isStartDetecte and not isGameFinished then
            --监测游戏是否已结束
            local allPlayers = curBattleScene:GetAllPlayersInBattle()
            local tagPlayer
            local isAllDead = true
            local activePlayersCount = 0
            for index=0,allPlayers.Count-1 do
                tagPlayer = allPlayers[index]
                if tagPlayer.bindBattleUnit ~= nil then
                    if tagPlayer:GetPlayerState("is_dead") <= 0 then
                        isAllDead = false
                        break
                    end
                    activePlayersCount = activePlayersCount + 1
                end
            end
            if isAllDead and activePlayersCount > 0 then
                curBattleScene:ClientExecBsCmdLines("DUNGEON_OVER*2", 0)
                isGameFinished = true
            end
        end
    end
end

--单位BUFF状态更改
function onUnitBuffChanged(_tagUnit, _tagBuff, _newOverlay)
    --监视玩家角色BUFF状态
    if _tagUnit == playerUnit and playerUnit ~= nil then
        if _tagBuff.buffID == '濒死待救' then
            local isDeadStr
            if _newOverlay > 0 then
                curBattleScene:SetControlPanelEnable(false)
                isDeadStr = "1"
            else
                curBattleScene:SetControlPanelEnable(true)
                SwitchWatchPlayer(playerUnit)
                isDeadStr = "0"
            end
            curBattleScene:SendUIMessage("on_playerdead", isDeadStr)
        end
    end

    if _tagBuff.buffID == '濒死待救' then
        if _tagUnit.isMuliplayerUnit == 1 then
            local tagPlayer = curBattleScene:GetPlayerInfo(_tagUnit.userID)
            if tagPlayer ~= nil then
                local isDeadCode = 0
                if _newOverlay > 0 then
                    isDeadCode = 1
                    isStartDetecte = true
                end
                if curBattleScene:IsHostClient() then
                    tagPlayer:SetPlayerState("is_dead", isDeadCode)
                end
                curBattleScene:SendUIMessage("update_stateinfo", tostring(_tagUnit.userID))
            end
        end
    end
end

--击败单位接口
function onUnitDefeatEnemy(_thisUnit, _tagUnit)
    if (_thisUnit == playerUnit) then
        --增加统计接口
        playerUnitDefeatCount = playerUnitDefeatCount + 1
        curBattleScene:SendUIMessage("info_updated", "")

        if (curBattleScene:GetDungeonMapID() == "风哭岩道环形" and GameMode == "Normal") then
            local CMD = "EVENT*风哭岩道进度Normal监测"
            curBattleScene:LocalExecBsCmdLines(CMD, 0)
        end
    end
end

--设置主角控制单位
function onSetPlayerUnit(_tagUnit)
    playerUnit = _tagUnit
    if playerUnit ~= nil then
        playerUnitID = playerUnit.unitID
        playerCurLevel = playerUnit.unitLevel
        playerRole = GameCoreHelper.GetPlayerRole()
        MyRole = playerUnit.unitRoleInfo
        curBattleScene:SetDungeonStrVal("MyRole",MyRole)
        if isNeedRecover then
            RecoverRoleSkills()
            isNeedRecover = false
        end
        updatePlayerSpNum()
    else
        playerUnitID = 0
    end
    curBattleScene:SendUIMessage("info_updated", "")
end

function onUnitLevelChanged(_tagUnit, _newLevel)
    if (_tagUnit == playerUnit) then
        playerCurLevel = _newLevel
        updatePlayerSpNum()
        curBattleScene:SendUIMessage("info_updated", "")
    end
end

function updatePlayerSpNum()
    totalPlayerGainedSp = playerCurLevel
end

function onUnitDie(_tagUnit)
    --do nothing
end

function GetPlayerUsableSp()
    return math.max(totalPlayerGainedSp - totalPlayerUsedSp, 0)
end

function func()
    -- body
end

--玩家当前的技能表
curPlayerSkillList = {}
curPlayerSkillCount = 0
isExistSynthSkills = false

skillPoolMaxLevel = 6
--玩家可供抽取的技能池
drawSpPool = {
    --一级技能
    {"OL钩镰",1,"力量",0},{"OL闪身斩",1,"力量",0},{"OL野蛮抡击",1,"力量",0},{"OL突刺",1,"力量",0},
    {"OL背刺",1,"敏捷",0},{"OL毒针",1,"敏捷",0},{"OL雾遁",1,"敏捷",0},{"OL药剂瓶",1,"敏捷",0},
    {"OL火球术",1,"精神",0},{"OL雷光",1,"精神",0},{"OL霜冻",1,"精神",0},{"OL魔魇支配",1,"精神",0},
    {"OL震撼波",1,"耐力",0},{"OL地碎",1,"耐力",0},{"OL千钧跃击",1,"耐力",0},{"OL盾击",1,"耐力",0},
    --二级技能
    {"OL英勇冲锋",2,"力量",0},{"OL气刃斩",2,"力量",0},{"OL吸血一击",2,"力量",0},{"OL双段斩",2,"力量",0},
    {"OL五枝",2,"敏捷",0},{"OL闪烁秘刃",2,"敏捷",0},{"OL火雷",2,"敏捷",0},{"OL飞星",2,"敏捷",0},
    {"OL水龙泡",2,"精神",0},{"OL雷电传送",2,"精神",0},{"OL火葬柴堆",2,"精神",0},{"OL火舌图腾",2,"精神",0},
    {"OL冲击波",2,"耐力",0},{"OL裂空",2,"耐力",0},{"OL举盾冲锋",2,"耐力",0},{"OL嘲讽图腾",2,"耐力",0},
    --三级技能
    {"OL狂暴斩",3,"力量",0},{"OL轰天怒击",3,"力量",0},{"OL气裂扫",3,"力量",0},{"OL钩锁突进",3,"力量",0},
    {"OL空息斩",3,"敏捷",0},{"OL剧毒之潮",3,"敏捷",0},{"OL幻光一闪",3,"敏捷",0},{"OL回旋镖",3,"敏捷",0},
    {"OL冰矛",3,"精神",0},{"OL火墙术",3,"精神",0},{"OL大治疗术",3,"精神",0},{"OL霜冻新星",3,"精神",0},
    {"OL风灵冲击",3,"耐力",0},{"OL巨人降临",3,"耐力",0},{"OL极速裂地斩",3,"耐力",0},{"OL弹力踩踏",3,"耐力",0},
    --四级技能
    {"OL秘技火凤",4,"力量",0},{"OL审判",4,"力量",0},{"OL灰烬之剑",4,"力量",0},{"OL旋风斩",4,"力量",0},
    {"OL沙风之弓",4,"敏捷",0},{"OL猎鹰破空",4,"敏捷",0},{"OL影杀",4,"敏捷",0},{"OL魂灭",4,"敏捷",0},
    {"OL冰封爆裂",4,"精神",0},{"OL熔岩之核",4,"精神",0},{"OL电烁魔球",4,"精神",0},{"OL裂隙之门",4,"精神",0},
    {"OL终焉一击",4,"耐力",0},{"OL霸体",4,"耐力",0},{"OL土之庇护",4,"耐力",0},{"OL飞鹰结合",4,"耐力",0},
    --五级技能
    {"OL耀斑冲击",5,"力量",0},{"OL圆月轮舞",5,"力量",0},{"OL魔剑墨痕",5,"力量",0},{"OL地狱镰刀",5,"力量",0},
    {"OL秘术分身",5,"敏捷",0},{"OL流星弹幕",5,"敏捷",0},{"OL毒刃缭乱",5,"敏捷",0},{"OL华丽登场",5,"敏捷",0},
    {"OL巫术脉冲",5,"精神",0},{"OL魔导莲华",5,"精神",0},{"OL红炎熔融",5,"精神",0},{"OL元素降临",5,"精神",0},
    {"OL机械掘进",5,"耐力",0},{"OL圣盾折返",5,"耐力",0},{"OL野性之舞",5,"耐力",0},--{"OL恶魔附体",5,"耐力",0},
    --六级技能
    {"OL杀戮盛宴",6,"力量",0},{"OL天霸摧星",6,"力量",0},
    {"OL瞬风灭杀闪",6,"敏捷",0},{"OL月夜魔刃",6,"敏捷",0},
    {"OL歪空六芒",6,"精神",0},{"OL冰龙召唤",6,"精神",0},
    {"OL巨龙冲击",6,"耐力",0}--,{"OL巨龙化身",6,"耐力",0}
}

--玩家抽技能操作
function PlayerDrawSkill()
    if playerRole == nil then
        return false
    end
    if GetPlayerUsableSp() > 0 and curPlayerSkillCount < actionBarSlotCount then
        local tagDrawLevel = 1
        if(totalPlayerUsedSp >= 17)then
            tagDrawLevel = 4
        elseif(totalPlayerUsedSp >= 14)then
            tagDrawLevel = 3
        elseif(totalPlayerUsedSp >= 8)then
            tagDrawLevel = 2
        end
        local drawType = playerRole.curRealStatu:getVal("draw_type")
        local tagDrawSp
        if(drawType > 0)then
            if(drawType == 1)then
                if(totalPlayerUsedSp == 0 or GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "力量")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 2)then
                if(totalPlayerUsedSp == 0 or GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "敏捷")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 3)then
                if(totalPlayerUsedSp == 0 or GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "精神")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 4)then
                if(totalPlayerUsedSp == 0 or GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "耐力")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            end
        else
            tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
        end

        if tagDrawSp ~= nil then
            SetPlayerSkill(tagDrawSp, nil)
            totalPlayerUsedSp = totalPlayerUsedSp + 1
            return true
        end
    end
    return false
end

function GetRandomNewSkill(_tagLevel, _tagSeries)
    local curDrawPool = {}
    local curPoolSize = 0
    for k, v in pairs(drawSpPool) do
        if v[2] == _tagLevel and not IsTagSkillExist(v[1]) then
            if _tagSeries == nil or _tagSeries == v[3] then
                curDrawPool[curPoolSize] = v
                curPoolSize = curPoolSize + 1
            end
        end
    end
    math.randomseed(os.time())
    local tagSp = nil
    if curPoolSize > 0 then
        tagSp = curDrawPool[GameCoreHelper.GetRandomInt(0, curPoolSize)]
    end
    return tagSp
end

--合成技能操作
function PlayerSynthSkill()
    if playerRole == nil then
        return
    end
    local tagSynthLevel = 0
    for k1, v1 in pairs(curPlayerSkillList) do
        for k2, v2 in pairs(curPlayerSkillList) do
            if k1 ~= k2 and v1[2] < skillPoolMaxLevel then
                if v1[2] == v2[2] and v1[3] == v2[3] and v1[4] == 0 and v2[4] == 0 then
                    tagSynthLevel = v1[2] + 1
                    local tagDrawSp = GetRandomNewSkill(tagSynthLevel, v1[3])
                    if tagDrawSp ~= nil then
                        SetPlayerSkill(tagDrawSp, {v1, v2})
                        return true
                    end
                    break
                end
            end
        end
    end
    return false
end

--替换技能操作
function ReplaceRndSkill(tagSp)
    errInfo = nil
    if playerRole == nil then
        return false, nil
    end
    if tagSp ~= nil then
        if(tagSp[4] == 1)then
            errInfo = "该技能已被锁定，请先解除锁定！"
            return false, errInfo
        end
        local costVal = GetReplaceSkillCostMoney(tagSp)
        if playerRole:GetResourceNum(RES_ID_MONEY, 1) < costVal then
            errInfo = string.format(GetGameString("MG1_Cmd_Dialog_Text23"), costVal)
            return false, errInfo
        end
        local tagDrawLevel = tagSp[2]
        local drawType = playerRole.curRealStatu:getVal("draw_type")
        local tagDrawSp
        if(drawType > 0)then
            if(drawType == 1)then
                if(GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "力量")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 2)then
                if(GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "敏捷")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 3)then
                if(GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "精神")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            elseif(drawType == 4)then
                if(GameCoreHelper.GetRandomBool(25))then
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, "耐力")
                else
                    tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
                end
            end
        else
            tagDrawSp = GetRandomNewSkill(tagDrawLevel, nil)
        end
        if tagDrawSp ~= nil then
            SetPlayerSkill(tagDrawSp, { tagSp })
            playerRole:ChangeResourceNum(RES_ID_MONEY, -costVal, false, 1)
            return 1
        end
    end
    return false, nil
end

--获取替换技能消耗金钱数
function GetReplaceSkillCostMoney(tagSp)
    if tagSp ~= nil then
        if(tagSp[2] == 1)then
            return 50
        elseif(tagSp[2] == 2)then
            return 150
        elseif(tagSp[2] == 3)then
            return 400
        elseif(tagSp[2] == 4)then
            return 900
        elseif(tagSp[2] == 5)then
            return 2000
        elseif(tagSp[2] == 6)then
            return 5000
        end
    end
    return 0
end

--遗忘技能操作
function RemoveTagSkill(tagSp)
    if playerRole == nil then
        return
    end
    if tagSp ~= nil then
        if(tagSp[4] == 1)then

            return false
        end
        SetPlayerSkill(nil, { tagSp })
        return true
    end
    return false
end

function LockTagSkill(tagSp)
    if playerRole == nil then
        return
    end
    if tagSp ~= nil then
        if(tagSp[4] == 0)then
            TryLockPlayerSkill(tagSp)
            return true
        elseif(tagSp[4] == 1)then
            TryUnLockPlayerSkill(tagSp)
            return false
        end
    end
    return
end

function TryLockPlayerSkill(_tagSp)
    _tagSp[4] = 1
    UpdatePlayerSkillCount()
    --更新UI
    curBattleScene:SendUIMessage("skills_changed", "")
end

function TryUnLockPlayerSkill(_tagSp)
    _tagSp[4] = 0
    UpdatePlayerSkillCount()
    --更新UI
    curBattleScene:SendUIMessage("skills_changed", "")
end

--技能是否上锁
function IsLocked(_tagSp)
    if(IsTagSkillExist(_tagSp[1]) and curPlayerSkillList[_tagSp[1]][4] == 1)then
        return true
    end
    return false
end

function SetPlayerSkill(_tagSp, _oldSpList)
    local isUpdated = false
    --移除旧技能
    local oldSkillIDs = ""
    local removeCount = 0
    if _oldSpList ~= nil then
        for k, v in pairs(_oldSpList) do
            if removeCount > 0 then
                oldSkillIDs = oldSkillIDs .. "|"
            end
            oldSkillIDs = oldSkillIDs .. v[1]
            curPlayerSkillList[v[1]] = nil
            removeCount = removeCount + 1
            isUpdated = true
        end
    end
    local newSkillID = ""
    if _tagSp ~= nil then
        --标记新技能
        curPlayerSkillList[_tagSp[1]] = _tagSp
        newSkillID = _tagSp[1]
        isUpdated = true
    end
    if isUpdated then
        --操作游戏内核
        local cmdLine = "SETSKILL*#" .. newSkillID .. "#" .. oldSkillIDs
        curBattleScene:LocalExecBsCmdLines(cmdLine, playerUnitID)

        UpdatePlayerSkillCount()
        --更新UI
        curBattleScene:SendUIMessage("skills_changed", "")
    end
end

function UpdatePlayerSkillCount()
    curPlayerSkillCount = 0
    isExistSynthSkills = false
    for k1, v1 in pairs(curPlayerSkillList) do
        curPlayerSkillCount = curPlayerSkillCount + 1
        if not isExistSynthSkills then
            for k2, v2 in pairs(curPlayerSkillList) do
                if k1 ~= k2 and v1[2] < skillPoolMaxLevel then
                    if v1[2] == v2[2] and v1[3] == v2[3] and v1[4] == 0 and v2[4] == 0 then
                        isExistSynthSkills = true
                        break
                    end
                end
            end
        end
    end
end

function IsTagSkillExist(_tagSkID)
    if curPlayerSkillList[_tagSkID] == nil then
        return false
    else
        return true
    end
end

function TestAddExp(_addVal)
    curBattleScene:LocalExecBsCmdLines("ADD_EXP*" .. _addVal, playerUnitID)
end

function TestSpawnMonstersNoBouns()
    --获取最近的几个刷怪区并且刷怪
    local maxAreasCount = 4
    local allSpawnAreas = curBattleScene:GetAllSpawnAreas()
    if allSpawnAreas == nil then
        return
    end
    local tagAreasPool = {}
    local unitPosX = 0
    local unitPosY = 0
    if playerUnit ~= nil then
        unitPosX = playerUnit.CurPos.x
        unitPosY = playerUnit.CurPos.y
    end
    local tagDist
    for i=0,allSpawnAreas.Count-1 do
        local tagArea = allSpawnAreas[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, unitPosX, unitPosY)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)
    --开始刷怪
    local curAreasCount = 0
    for k,v in pairs(tagAreasPool) do
        if curAreasCount >= maxAreasCount then
            break
        end
        local tagCmd = GetSpawnEnemyCMD("meleeSummon", v.id, playerCurLevel+2, "LUA刷出", "0:0")
        if(curAreasCount == 2)then
            tagCmd = GetSpawnEnemyCMD("rangeSummon", v.id, playerCurLevel+2, "LUA刷出", "0:0")
        end
        curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
        curAreasCount = curAreasCount + 1
    end
end

function TestSpawnMonsters()
    --获取最近的几个刷怪区并且刷怪
    local maxAreasCount = 12
    local allSpawnAreas = curBattleScene:GetAllSpawnAreas()
    if allSpawnAreas == nil then
        return
    end
    local tagAreasPool = {}
    local unitPosX = 0
    local unitPosY = 0
    if playerUnit ~= nil then
        unitPosX = playerUnit.CurPos.x
        unitPosY = playerUnit.CurPos.y
    end
    local tagDist
    for i=0,allSpawnAreas.Count-1 do
        local tagArea = allSpawnAreas[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, unitPosX, unitPosY)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)
    --开始刷怪
    local curAreasCount = 0
    for k,v in pairs(tagAreasPool) do
        if curAreasCount >= maxAreasCount then
            break
        end
        if(curAreasCount%4 == 0)then
            local enemyTable = eliteTable[GameCoreHelper.GetRandomInt(1, #eliteTable+1)]
            local enemyID = enemyTable[1]
            local triggerID = GetTrigger(enemyTable[2])
            local tagCmd = "AREA_SPAWN*" .. v.id .. "#" .. enemyID .. "," .. tostring(playerCurLevel) .. "##1#0:0#LUA刷出#" .. triggerID
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
        end
        local tagCmd = GetSpawnEnemyCMD("melee", v.id, playerCurLevel+2, "LUA刷出", "0:0")
        if(curAreasCount%2 == 0)then
            tagCmd = GetSpawnEnemyCMD("range", v.id, playerCurLevel+2, "LUA刷出", "0:0")
        end
        curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
        curAreasCount = curAreasCount + 1
    end
end

meleeEnemyTable = {
    [1] = {"荒原狼"},
    [3] = {"毒蛇","毒蝎","荒原狼"},
    [5] = {"野牛","棕熊","毒蛇","毒蝎","荒原狼"},
    [7] = {"鱼人战士","咕噜","野牛","棕熊","毒蛇","毒蝎","荒原狼"},
    [9] = {"傀儡","蜥蜴人勇士","鱼人战士","咕噜","野牛","棕熊","毒蛇","毒蝎","荒原狼"},
    [10] = {"人马","雷电女妖","傀儡","蜥蜴人勇士","鱼人战士","咕噜","野牛","棕熊","毒蛇","毒蝎","荒原狼"},
    --[11] = {"巨鹰"},
    --[12] = {"巨人守卫","符文傀儡"},
    --[13] = {"树人","花岗岩巨人"},
    --[14] = {"毒龙"},
    --[15] = {"恶魔","火龙","冰龙"},
}

rangeEnemyTable = {
    [1] = {"沙虫"},
    [3] = {"灵狐","沙虫"},
    [5] = {"毒蜥","灵狐","沙虫"},
    [7] = {"鱼人巫师","毒蜥","灵狐","沙虫"},
    [10] = {"诅咒女妖","鱼人巫师","毒蜥","灵狐","沙虫"},
    --[12] = {"圣蛇","剧毒女妖"},
    --[13] = {"巨人巫师","恐惧女妖"},
    --[14] = {"凤凰"},
}

function GetSpawnEnemyCMD(_tagString,_tagID, _level, _controlID, _tacticsID)
    local tagTable = meleeEnemyTable
    if(_tagString == "range")then
        tagTable = rangeEnemyTable
    end
    if(_tagString == "meleeSummon")then
        tagTable = meleeEnemyTable
    end
    if(_tagString == "rangeSummon")then
        tagTable = rangeEnemyTable
    end
    local tobeRandomedTable = {}
    local tobeRandomedTableIndex = 0
    for k,v in pairs(tagTable) do
        if(tonumber(k) <= tonumber(_level))then
            tobeRandomedTable[tobeRandomedTableIndex] = tonumber(k)
            tobeRandomedTableIndex = tobeRandomedTableIndex + 1
        end
    end
    local randomIndex = 1
    if(#tobeRandomedTable > 0)then
        randomIndex = GetRandomTableByWeight(tobeRandomedTable)[1].index
    end
    if(_tacticsID == nil)then
        _tacticsID = "0:2000"
    end
    local enemyTable = tagTable[randomIndex]
    local enemyId = enemyTable[GameCoreHelper.GetRandomInt(1,#enemyTable+1)]
    local hpRate = math.ceil(playerCurLevel * (1 + playerCount))
    local triggerID = GetTrigger("Melee")
    local CMD = "AREA_SPAWN*" .. _tagID .. "##" .. enemyId ..",1,1," .. tostring(playerCurLevel) .. "#1#" .._tacticsID .. "#" .. _controlID .. "#" .. triggerID
    if(_tagString == "meleeSummon")then
        CMD = "AREA_SPAWN*" .. _tagID .. "##召唤" .. enemyId ..",1,1," .. tostring(playerCurLevel) .. "#1#" .._tacticsID .. "#" .. _controlID .. "#" .. triggerID
    end
    if(_tagString ==  "range")then
        local triggerID = GetTrigger("Range")
        CMD = "AREA_SPAWN*" .. _tagID .. "##" .. enemyId ..",1,1," .. tostring(playerCurLevel) .. "#1#" .. _tacticsID .. "#" .. _controlID .. "#" .. triggerID
    end
    if(_tagString ==  "rangeSummon")then
        local triggerID = GetTrigger("Range")
        CMD = "AREA_SPAWN*" .. _tagID .. "##召唤" .. enemyId ..",1,1," .. tostring(playerCurLevel) .. "#1#" .. _tacticsID .. "#" .. _controlID .. "#" .. triggerID
    end
    return CMD
end

--按权重从table中随机取n个子table，其中k是子table，v是对应权重，最后返回一个table，按前后顺序取
function GetRandomTableByWeight(_table)
    local newTable = {}
    for k,v in pairs(_table) do
        math.randomseed(tostring(os.time()):reverse():sub(1, 7))
        local p = math.random() * tonumber(v+20)
        table.insert(newTable, {index = v, num = p})
    end
    table.sort(newTable, function(a,b) return a.num > b.num end)
    return newTable
end

function HealSpring()
    local CMD = "EXEC_SKILL*PLAYER#OL治疗之泉##"
    curBattleScene:ClientExecBsCmdLines(CMD, playerUnitID)
end

function Harmful()
    local CMD = "EXEC_SKILL*PLAYER#OL毒雾自己伤血##"
    curBattleScene:ClientExecBsCmdLines(CMD, playerUnitID)
end

function SummonSoldier()
    local money = playerRole:GetResourceNum(RES_ID_MONEY, 1)
    local costMoney = math.floor(money * 0.2)
    playerRole:ChangeResourceNum(RES_ID_MONEY, -costMoney, false, 1)
    local UnitID = "雇佣兵1"
    if(costMoney >= 200)then
        UnitID = "雇佣兵3"
    elseif(costMoney >= 100)then
        UnitID = "雇佣兵2"
    end
    local AreaTable = GetSpawnAreaByDistance()
    local hpRate = math.floor(100 + costMoney/2 * 1.5 * playerCount)
    local dmgRate = math.floor(10 + costMoney/10 * 1.5 * playerCount)
    local status = GameTools:GetRoleLevelBaseStatu(playerCurLevel);
    local hpAdd = math.floor(status:getVal("s_生命") * hpRate/100)
    local triggerID = "s_标准生命百分比," .. hpRate .. "|pup_全部," .. dmgRate
    if(costMoney >= 150)then
        triggerID = triggerID .. "|" .. triggerTable[GameCoreHelper.GetRandomInt(1, #triggerTable+1)]
    end
    local SKILLCMD = "SKILL_CMD*PLAYER##0#summon_unit#1#" .. UnitID  .. "," .. tostring(playerCurLevel) .. "#unit_pos,[%rnd:-400,400%],[%rnd:-400,400%],0#0#" .. triggerID .. "#0#caster##2,1000"
    curBattleScene:ClientExecBsCmdLines(SKILLCMD, playerUnitID)
end

function TreasureGuadian()
    local players = curBattleScene:GetAllPlayersInBattle()
    for i=0, players.Count-1 do
        local playerI = players[i]
        local areas = GetNearestSpawnArea(playerI.bindLocalUnit.CurPos.x,playerI.bindLocalUnit.CurPos.y)
        local enemyID = "守护者"
        local triggerID = GetTrigger("EliteMagic")
        local tagCmd = "AREA_SPAWN*" .. areas[1].id .. "#" .. enemyID .. "," .. tostring(playerCurLevel+1) .. "##1#0:2500#特殊刷怪#" .. triggerID
        curBattleScene:ClientExecBsCmdLines(tagCmd, playerUnitID)
    end
end

function TreasureExpTester()
    local players = curBattleScene:GetAllPlayersInBattle()
    for i=0, players.Count-1 do
        local playerI = players[i]
        local areas = GetNearestSpawnArea(playerI.bindLocalUnit.CurPos.x,playerI.bindLocalUnit.CurPos.y)
        local enemyID = "考验者"
        local triggerID = GetTrigger("EliteMagic")
        local tagCmd = "AREA_SPAWN*" .. areas[1].id .. "#" .. enemyID .. "," .. tostring(playerCurLevel+1) .. "##1#0:2500#特殊刷怪#" .. triggerID
        curBattleScene:ClientExecBsCmdLines(tagCmd, playerUnitID)
    end
end

function TreasureMoneyMiner()
    local players = curBattleScene:GetAllPlayersInBattle()
    for i=0, players.Count-1 do
        local playerI = players[i]
        local areas = GetNearestSpawnArea(playerI.bindLocalUnit.CurPos.x,playerI.bindLocalUnit.CurPos.y)
        local enemyID = "恶灵矿工"
        for k=1,2 do
            local triggerID = GetTrigger("EliteMagic")
            local tagCmd = "AREA_SPAWN*" .. areas[k].id .. "#" .. enemyID .. "," .. tostring(playerCurLevel+1) .. "##1#0:2500#特殊刷怪#" .. triggerID
            curBattleScene:ClientExecBsCmdLines(tagCmd, playerUnitID)
        end
    end
end

--普通交互物，交互一定成功
NormalObjectTable = {
    {GetGameString("MG1_Interactive_Obj_Info_1"), "ol石像1", "石像1","psChestFlash1,0,0","OL士兵雕像"},
    {GetGameString("MG1_Interactive_Obj_Info_2"), "废墟", "废墟2","psChestFlash1,0,0","OL试炼遗迹"},
    {GetGameString("MG1_Interactive_Obj_Info_3"), "ol招募药剂房小B", "招募药剂房小B","psChestFlash1,0,0","OL经验遗迹"},
    {GetGameString("MG1_Interactive_Obj_Info_4"), "ol闪金矿井", "ol闪金矿井2","psChestFlash1,0,0","OL闪金矿井"}
}

HealObjectsTable = {
    {GetGameString("MG1_Interactive_Obj_Info_Heal1"), "ol火魔井", "火魔井","psChestFlash1,0,0","OL治疗之泉"},
}

OnlineStoreObject = {
    {GetGameString("MG1_Interactive_Obj_Info_Store1"), "联机商店1反","联机商店1反","psChestFlash1,0,0","OL在线商店"}
}

--商店类交互物，当金钱不足时可能会失败，消耗的金钱在生成地图时根据玩家等级确定
StoreObjectTable = {
    {GetGameString("MG1_Interactive_Obj_Info_StoreObj1"), "帐篷02","帐篷022","psChestFlash1,0,0","OL饰品商店"},
    {GetGameString("MG1_Interactive_Obj_Info_StoreObj2"), "铁匠铺","铁匠铺2","psChestFlash1,0,0","OL防具商店"},
    {GetGameString("MG1_Interactive_Obj_Info_StoreObj3"), "武器架02","武器架022","psChestFlash1,0,0","OL武器商店"},
}

function GetStoreBuffCostNum()
    return (mapLevel+1)*40 + 50
end

--祭坛类交互物，当金钱不足时可能会失败，消耗的金钱在生成地图时根据玩家等级确定
StoreBuffObjectTable = {
    ["疾风祭坛"] = {string.format(GetGameString("MG1_Interactive_Obj_Info_BuffObj1"), GetStoreBuffCostNum()), "雪山女神建筑","雪山女神建筑","psChestFlash1,0,0","OL疾风祭坛"},
    ["复苏祭坛"] = {string.format(GetGameString("MG1_Interactive_Obj_Info_BuffObj2"), GetStoreBuffCostNum()), "大河女神建筑","大河女神建筑","psChestFlash1,0,0","OL复苏祭坛"},
    ["怪力祭坛"] = {string.format(GetGameString("MG1_Interactive_Obj_Info_BuffObj3"), GetStoreBuffCostNum()), "图腾红","图腾红","psChestFlash1,0,0","OL怪力祭坛"},
    ["精神祭坛"] = {string.format(GetGameString("MG1_Interactive_Obj_Info_BuffObj4"), GetStoreBuffCostNum()), "图腾蓝","图腾蓝","psChestFlash1,0,0","OL精神祭坛"}
}

TreasureTable = {
    {"chest1Big","chest1_openBig"},
    {"chest2Big","chest2_openBig"},
    {"chest3Big","chest3_openBig"},
    {"chest4Big","chest4_openBig"}
}

--做一些交互物数据的缓存
ObjectCacheTable = {}

eliteTable = {
    {"鱼人战士精英","EliteMelee"},
    {"雷电女妖精英","EliteMagic"},
    {"诅咒女妖精英","EliteMagic"},
    {"荒原狼精英","EliteMelee"},
    {"沙虫精英","EliteRange"},
    {"灵狐精英","EliteRange"},
    {"蜘蛛精英","EliteMagic"},
    {"蜥蜴人精英","EliteMelee"}
}

triggerTable = {
    "overrideNamePre_燃烧的,1|ol_燃烧攻击,100",
    "overrideNamePre_冰冻的,1|ol_移动缓速,100",
    "overrideNamePre_疾风的,1|s_移速,200",
    "overrideNamePre_启迪的,1|cd_所有冷却,50",
    "overrideNamePre_雷霆的,1|ol_闪电攻击,100",
    "overrideNamePre_荆棘的,1|udatk_反伤,100",
    "overrideNamePre_复苏的,1|s_生命回复,30",
    "overrideNamePre_剧毒的,1|ol_毒素攻击,100",
    "overrideNamePre_狂热的,1|s_暴击,75|s_被暴击,50",
    "overrideNamePre_爆裂的,1|ol_dead炸裂,1",
    "overrideNamePre_熟练的,1|bf_免疫控制,1",
    "overrideNamePre_锯齿的,1|ol_流血效果,100|s_攻击,50",
    "overrideNamePre_怪力的,1|ol_攻击击退大,100|s_攻击,25",
    "overrideNamePre_瘟疫的,1|ol_dead瘟疫,1",
    "overrideNameSuf_之王,1|udatk_伤害免除,50|pup_全部,35|s_移速,100|cd_所有冷却,25"
}

function Ptest(_p)
    return GameCoreHelper.GetRandomBool(_p*100)
end

function SortTableByDistance(_tagPool)
    if playerUnit == nil then
        return nil
    end
    local tagAreasPool = {}
    local unitPosX = playerUnit.CurPos.x
    local unitPosY = playerUnit.CurPos.y
    local tagDist
    for i=0,_tagPool.Count-1 do
        local tagArea = _tagPool[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, unitPosX, unitPosY)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist, x=tagArea.centerPos.x, y=tagArea.centerPos.y })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)
    return tagAreasPool
end

function GetSpawnAreaByDistance()
    local tagAreasPool = {}
    local allSpawnAreas = curBattleScene:GetAllSpawnAreas()
    if allSpawnAreas == nil then
        return tagAreasPool
    end
    if playerUnit ~= nil then
        unitPosX = playerUnit.CurPos.x
        unitPosY = playerUnit.CurPos.y
    else
        if (curBattleScene:GetDungeonMapID() == "红石山谷") then
            unitPosX = curBattleScene:GetBattleRealPosByMapPos(-3300,-1584).x
            unitPosY = curBattleScene:GetBattleRealPosByMapPos(-3300,-1584).y
        elseif (curBattleScene:GetDungeonMapID() == "花卉密林") then
            unitPosX = curBattleScene:GetBattleRealPosByMapPos(-980,-1418).x
            unitPosY = curBattleScene:GetBattleRealPosByMapPos(-980,-1418).y
        elseif (curBattleScene:GetDungeonMapID() == "风哭岩道") then
            unitPosX = curBattleScene:GetBattleRealPosByMapPos(3,-9352).x
            unitPosY = curBattleScene:GetBattleRealPosByMapPos(3,-9352).y
        elseif (curBattleScene:GetDungeonMapID() == "环形红石山谷") then
            unitPosX = curBattleScene:GetBattleRealPosByMapPos(-964,-3717).x
            unitPosY = curBattleScene:GetBattleRealPosByMapPos(-964,-3717).y
        end
    end
    local tagDist
    for i=0,allSpawnAreas.Count-1 do
        local tagArea = allSpawnAreas[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, unitPosX, unitPosY)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist, x=tagArea.centerPos.x, y=tagArea.centerPos.y })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)
    return tagAreasPool
end

function GetNearestSpawnArea(_x,_y)
    local tagAreasPool = {}
    local allSpawnAreas = curBattleScene:GetAllSpawnAreas()
    if allSpawnAreas == nil then
        return tagAreasPool
    end

    local tagDist
    for i=0,allSpawnAreas.Count-1 do
        local tagArea = allSpawnAreas[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, _x, _y)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist, x=tagArea.centerPos.x, y=tagArea.centerPos.y })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)
    return tagAreasPool
end

function InitMapObjectsNew(_ctlID)
    local tagAreasPool
    if(_ctlID == nil)then
        tagAreasPool = curBattleScene:GetAllSpawnAreas()
    else
        tagAreasPool = curBattleScene:GetAllSpawnAreasByIdContains(_ctlID)
    end
    local mapObjectCnt = 6 + playerCount * 6 + GameCoreHelper.GetRandomInt(2,7)
    local treasureCnt = 2 + playerCount * 3 + GameCoreHelper.GetRandomInt(1,5)

    local objectGap = tagAreasPool.Count/mapObjectCnt
    local treasureGap = tagAreasPool.Count/treasureCnt
    local mapObjects = 0
    local mapObjectsFactor = 0
    local treasures = 0
    for i=0, tagAreasPool.Count-1 do
        local p1 = math.max(0.2 + (i - objectGap * mapObjects) * 0.3,0)
        local p2 = math.max(0.2 + (i - treasureGap * treasures) * 0.5,0)
        if(mapLevel == 1 and i <= playerCount*2)then
            p2 = p2 + 0.5
        end
        if(i > playerCount*2 and p1 > 0 and Ptest(p1))then
            local x = tagAreasPool[i].centerPos.x
            local y = tagAreasPool[i].centerPos.y
            local locationPos = curBattleScene:GetMapPosByRealPos(x, y)
            local location = locationPos.x .. "," .. locationPos.y
            if(mapObjectsFactor%4 == 0)then
                local index = GameCoreHelper.GetRandomInt(1,#StoreObjectTable+1)
                local tableCMD = StoreObjectTable[index]
                local moneyCount = (mapLevel*2+1)*60+25*mapLevel+math.max(mapLevel-4,0)*45+math.max(mapLevel-6,0)*65+math.max(mapLevel-9,0)*95+math.max(mapLevel-11,0)*135
                if(index == 2)then
                    moneyCount = (mapLevel*2+1)*50+25*mapLevel+math.max(mapLevel-4,0)*40+math.max(mapLevel-6,0)*60+math.max(mapLevel-9,0)*90+math.max(mapLevel-11,0)*120
                elseif(index == 3)then
                    moneyCount = (mapLevel*2+1)*70+30*mapLevel+math.max(mapLevel-4,0)*50+math.max(mapLevel-6,0)*75+math.max(mapLevel-9,0)*100+math.max(mapLevel-11,0)*150
                end
                local CMD = "ADD_INTER_OBJECT*" .. string.format(tableCMD[1], moneyCount) .. "#" .. location .. "#" .. tableCMD[2] .. "#" .. tableCMD[3] .. "#" .. tableCMD[4] .. "#0#交互物" .. i .. "##" .. tableCMD[5] .. mapLevel .. "#2"
                curBattleScene:ClientExecBsCmdLines(CMD, 0)
            elseif(mapObjectsFactor%4 == 1)then
                local tableCMD = HealObjectsTable[1]
                local CMD = "ADD_INTER_OBJECT*" .. tableCMD[1] .. "#" .. location .. "#" .. tableCMD[2] .. "#" .. tableCMD[3] .. "#" .. tableCMD[4] .. "#0#交互物" .. i .. "##" .. tableCMD[5] .. "#2"
                curBattleScene:ClientExecBsCmdLines(CMD, 0)
            elseif(mapObjects > playerCount and mapLevel > 1)then
                local index = GameCoreHelper.GetRandomInt(1,#NormalObjectTable+1)
                local tableCMD = NormalObjectTable[index]
                local CMD = "ADD_INTER_OBJECT*" .. tableCMD[1] .. "#" .. location .. "#" .. tableCMD[2] .. "#" .. tableCMD[3] .. "#" .. tableCMD[4] .. "#0#交互物" .. i .. "##" .. tableCMD[5] .. "#2"
                curBattleScene:ClientExecBsCmdLines(CMD, 0)
            else
                local index = GameCoreHelper.GetRandomInt(1,#StoreObjectTable+1)
                local tableCMD = StoreObjectTable[index]
                local moneyCount = (mapLevel*2+1)*60+25*mapLevel+math.max(mapLevel-4,0)*45+math.max(mapLevel-6,0)*65+math.max(mapLevel-9,0)*95+math.max(mapLevel-11,0)*135
                if(index == 2)then
                    moneyCount = (mapLevel*2+1)*50+25*mapLevel+math.max(mapLevel-4,0)*40+math.max(mapLevel-6,0)*60+math.max(mapLevel-9,0)*90+math.max(mapLevel-11,0)*120
                elseif(index == 3)then
                    moneyCount = (mapLevel*2+1)*70+30*mapLevel+math.max(mapLevel-4,0)*50+math.max(mapLevel-6,0)*75+math.max(mapLevel-9,0)*100+math.max(mapLevel-11,0)*150
                end
                local CMD = "ADD_INTER_OBJECT*" .. string.format(tableCMD[1], moneyCount) .. "#" .. location .. "#" .. tableCMD[2] .. "#" .. tableCMD[3] .. "#" .. tableCMD[4] .. "#0#交互物" .. i .. "##" .. tableCMD[5] .. mapLevel .. "#2"
                curBattleScene:ClientExecBsCmdLines(CMD, 0)
            end
            mapObjects = mapObjects + 1
            mapObjectsFactor = mapObjectsFactor + 1
        elseif(p2 > 0 and Ptest(p2))then
            local locationPos = curBattleScene:GetMapPosByRealPos(tagAreasPool[i].centerPos.x, tagAreasPool[i].centerPos.y)
            local location = locationPos.x .. "," .. locationPos.y
            local tableCMD = RandomTableElement(TreasureTable)
            local CMD = "ADD_INTER_OBJECT*" .. GetGameString("MG1_Cmd_Dialog_Text24") .. "#" .. location .. "#" .. tableCMD[1] .. "#" .. tableCMD[2] .. "#psChestFlash1,0,0#0#交互物" .. i .. "##OL开箱事件#2"
            curBattleScene:ClientExecBsCmdLines(CMD, 0)
            treasures = treasures + 1
        end
    end
end

function AddJindu()
    local CMD = "SET_DG_INTVAR*游戏主进程进度#1#1#" .. GetGameString("MG1_Cmd_Dialog_Text25")
    curBattleScene:ClientExecBsCmdLines(CMD, 0)
end

--之所以在这边的luaFunc中回调EVENT是因为CALL_LUAFUNC似乎是一个异步指令，不会等LUA执行完就会直接接着执行EVENT中的指令，因此写在这里强制同步执行
function SpawnAreaSpecial1()
    SpawnEnemy("刷怪区域1")
    local CMD = "SET_DG_INTVAR*游戏主进程进度#[%unitnum:刷怪区域1%]#0#" .. GetGameString("MG1_Cmd_Dialog_Text26")
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end
function SpawnAreaSpecial2()
    SpawnEnemy("刷怪区域2")
    local CMD = "SET_DG_INTVAR*游戏主进程进度#[%unitnum:刷怪区域2%]#0#" .. GetGameString("MG1_Cmd_Dialog_Text26")
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end
function SpawnAreaSpecial3()
    SpawnEnemy("刷怪区域3")
    local CMD = "SET_DG_INTVAR*游戏主进程进度#[%unitnum:刷怪区域3%]#0#" .. GetGameString("MG1_Cmd_Dialog_Text26")
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end
function SpawnAreaSpecial4()
    SpawnEnemy("刷怪区域4")
    local CMD = "SET_DG_INTVAR*游戏主进程进度#[%unitnum:刷怪区域4%]#0#" .. GetGameString("MG1_Cmd_Dialog_Text27")
    curBattleScene:LocalExecBsCmdLines(CMD, 0)
end

function SpawnArea1()
    SpawnEnemy("刷怪区域1")
end
function SpawnArea2()
    SpawnEnemy("刷怪区域2")
end
function SpawnArea3()
    SpawnEnemy("刷怪区域3")
end
function SpawnArea4()
    SpawnEnemy("刷怪区域4")
end
function SpawnArea5()
    SpawnEnemy("刷怪区域5")
end

function SpawnEnemy(_ctlID)
    local spwanAreas
    if(_ctlID == nil)then
        spwanAreas = curBattleScene:GetAllSpawnAreas()
        _ctlID = "缺省刷怪"
    else
        spwanAreas = curBattleScene:GetAllSpawnAreasByIdContains(_ctlID)
    end
    if(spwanAreas == nil)then
        return
    end

    local elite = 0
    for i=0, spwanAreas.Count-1 do
        local areaID = spwanAreas[i].controlID
        if(Ptest(0.15) and elite < playerCount)then
            elite = elite + 1
            local enemyTable = eliteTable[GameCoreHelper.GetRandomInt(1, #eliteTable+1)]
            local enemyID = enemyTable[1]
            local triggerID = GetTrigger(enemyTable[2])
            local tagCmd = "AREA_SPAWN*" .. areaID .. "#" .. enemyID .. "," .. tostring(playerCurLevel) .. "##1#1:2000#" .. _ctlID .. "#" .. triggerID
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
        elseif(Ptest(0.8))then
            local tagCmd = ""
            if(Ptest(0.5))then
                tagCmd = GetSpawnEnemyCMD("range", areaID, playerCurLevel, _ctlID, "0:2500")
            else
                tagCmd = GetSpawnEnemyCMD("melee", areaID, playerCurLevel, _ctlID, "0:2000")
            end
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
        end
    end
end

function SAVEDATA()
    if curBattleScene:IsHostClient() and GameCoreHelper.GetPlayerRole() ~= nil then
        curBattleScene:SetDungeonIntVal("LEVEL", GameCoreHelper.GetPlayerRole().roleLevel)
    end
    curBattleScene:SetDungeonIntVal("MONEY", playerRole:GetResourceNum(RES_ID_MONEY, 1))
end

function BOSSDEAD()
    if curBattleScene:IsHostClient() and GameCoreHelper.GetPlayerRole() ~= nil then
        curBattleScene:SetDungeonIntVal("LEVEL", GameCoreHelper.GetPlayerRole().roleLevel)
        local dgLevel = curBattleScene:GetDungeonIntVal("BOSS阵亡数")
        if dgLevel <= 0 then
            local tagCmd = "BB*银珊#" .. GetGameString("MG1_Cmd_Dialog_Text28") .. "#0"
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
            tagCmd = "EVENT*首领阵亡切图"
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        elseif dgLevel <= 1 then
            local tagCmd = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text29") .. "#0"
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
            tagCmd = "EVENT*首领阵亡切图2"
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        elseif dgLevel <= 2 then
            local tagCmd = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text29") .. "#0"
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
            tagCmd = "EVENT*首领阵亡切图3"
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        elseif dgLevel<= 3 then
            local tagCmd = "BB*智能服务AI#" .. GetGameString("MG1_Cmd_Dialog_Text29") .. "#0"
            curBattleScene:ClientExecBsCmdLines(tagCmd, 0)
            tagCmd = "EVENT*首领阵亡切图4"
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        else
            local tagCmd = "EVENT*守护大河女神胜利"
            curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
        end
        curBattleScene:SetDungeonIntVal("BOSS阵亡数", dgLevel + 1)
    end
end

function GetRoleStrength()
    if(GameCoreHelper.GetPlayerRole() == nil)then
        return 0
    else
        return GameCoreHelper.GetPlayerRole().curRealStatu:getVal("b_臂力")
    end
end

function GetRoleAgility()
    if(GameCoreHelper.GetPlayerRole() == nil)then
        return 0
    else
        return GameCoreHelper.GetPlayerRole().curRealStatu:getVal("b_身法")
    end
end

function GetRoleIntelligence()
    if(GameCoreHelper.GetPlayerRole() == nil)then
        return 0
    else
        return GameCoreHelper.GetPlayerRole().curRealStatu:getVal("b_精神")
    end
end

function GetRoleEndurance()
    if(GameCoreHelper.GetPlayerRole() == nil)then
        return 0
    else
        return GameCoreHelper.GetPlayerRole().curRealStatu:getVal("b_根骨")
    end
end

function SpawnBoss()
    local allSpawnAreas = curBattleScene:GetAllSpawnAreas()
    if allSpawnAreas == nil then
        return
    end
    local tagAreasPool = {}
    local unitPosX = -3300
    local unitPosY = -1584
    if playerUnit ~= nil then
        unitPosX = playerUnit.CurPos.x
        unitPosY = playerUnit.CurPos.y
    end
    local tagDist
    for i=0,allSpawnAreas.Count-1 do
        local tagArea = allSpawnAreas[i]
        tagDist = Vector2Distance(tagArea.centerPos.x, tagArea.centerPos.y, unitPosX, unitPosY)
        table.insert(tagAreasPool, { id=tagArea.controlID, dist=tagDist })
    end
    table.sort(tagAreasPool, function(a,b) return a.dist<b.dist end)

    local areaID = tagAreasPool[1].id
    local triggerID = GetTrigger("Boss")
    local BossId = BossTable[GameCoreHelper.GetRandomInt(1,#BossTable+1)]
    local tagCmd = "AREA_SPAWN*" .. areaID .. "#" .. BossId .. "," .. tostring(playerCurLevel) .. "##1#0:15000#BOSS刷出#" .. triggerID
    curBattleScene:LocalExecBsCmdLines(tagCmd, 0)
end

function RandomTableElement(_table)
    local tmpKeyT={}
    local n=1
    for k,v in pairs(_table) do
        tmpKeyT[n]=k
        n=n+1
    end
    return _table[tmpKeyT[GameCoreHelper.GetRandomInt(1,n)]]
end

function PlayerDropItem(tagItem)
    curBattleScene:PlayerDropItemFromInventory(tagItem)
end

function PlayerUseBattleItem(tagItem)
    curBattleScene:UseBattleItem(tagItem)
end

function GetBattleItemCDTimer(itemID)
    return curBattleScene:GetBattleItemCDTimer(itemID)
end

function SetPlayerActiveItem(tagItem)
    curBattleScene:SetPlayerActiveItem(tagItem)
end

function Split(szFullString, szSeparator)
    local nFindStartIndex = 1
    local nSplitIndex = 1
    local nSplitArray = {}
    while true do
       local nFindLastIndex = string.find(szFullString, szSeparator, nFindStartIndex)
       if not nFindLastIndex then
        nSplitArray[nSplitIndex] = string.sub(szFullString, nFindStartIndex, string.len(szFullString))
        break
       end
       nSplitArray[nSplitIndex] = string.sub(szFullString, nFindStartIndex, nFindLastIndex - 1)
       nFindStartIndex = nFindLastIndex + string.len(szSeparator)
       nSplitIndex = nSplitIndex + 1
    end
    return nSplitArray
end

function GetSpInfoFromPool(skID)
    for k, tagSp in pairs(drawSpPool) do
        if tagSp[1] == skID then
            return tagSp
        end
    end
    return nil
end

function RecoverRoleSkills()
    local recordSkillInfo = curBattleScene:GetPlayerProperty("record_skill")
    local usedSpInfo = curBattleScene:GetPlayerProperty("total_used_sp")
    if usedSpInfo ~= nil and usedSpInfo ~= "" then
        totalPlayerUsedSp = math.floor(tonumber(usedSpInfo))
    end
    if recordSkillInfo == nil or recordSkillInfo == "" then
        return
    end
    local tagSpInfoList = Split(recordSkillInfo, "|")
    local tagSp
    curPlayerSkillList = {}
    for k, tagSpInfo in pairs(tagSpInfoList) do
        if tagSpInfo ~= nil then
            tagSp = GetSpInfoFromPool(tagSpInfo)
            if tagSp ~= nil then
                curPlayerSkillList[tagSp[1]] = tagSp
            end
        end
    end

    UpdatePlayerSkillCount()
    --更新UI
    curBattleScene:SendUIMessage("skills_changed", "")
end

function SaveSkillInfos()
    local strSkillList = ""
    local spCount = 0
    for k, tagSp in pairs(curPlayerSkillList) do
        if tagSp ~= nil then
            if spCount > 0 then
                strSkillList = strSkillList .. "|"
            end
            strSkillList = strSkillList .. tagSp[1]
            spCount = spCount + 1
        end
    end
    curBattleScene:SetPlayerProperty("record_skill", strSkillList)
    curBattleScene:SetPlayerProperty("total_used_sp", tostring(totalPlayerUsedSp))
end

--商店相关逻辑
function OpenRemoteShopWindow()
    local tagCom = "RemoteTradeBox"
    if GameTools.IsMobileMode() then
        tagCom = "RemoteTradeBoxM"
    end
    curRemoteShopWindow = CS.GUIHelper.ShowGUIWindow("MyGUI", tagCom, "RemoteShopWindow", "", onCloseRemoteShopWindow)
    curRemoteShopWindow:SetBattleScene(curBattleScene)
end

function onCloseRemoteShopWindow(ret)
    curRemoteShopWindow = nil
end

function BsGameInfoUpdated()
    --更新商店中的物品栏显示
    if curRemoteShopWindow ~= nil then
        curRemoteShopWindow:OnWindowEvent("bag_updated", _val)
    end
end

local curDebugIndex = 0
--测试代码
function DebugFunction()
    if playerRole == nil then
        return
    end
    if curPlayerSkillCount < actionBarSlotCount then
        local tagDrawSp = nil
        local curIndex = 0
        for k, tagSp in pairs(drawSpPool) do
            if curIndex == curDebugIndex then
                tagDrawSp = tagSp
            end
            curIndex = curIndex + 1
        end
        curDebugIndex = curDebugIndex + 1
        if curDebugIndex >= curIndex then
            curDebugIndex = 0
        end
        if tagDrawSp ~= nil then
            SetPlayerSkill(tagDrawSp, nil)
            return
        end
    else
        SetPlayerSkill(nil, curPlayerSkillList)
    end
end

function DebugFunction2()
    if playerRole == nil then
        return
    end
    playerRole:ChangeResourceNum(RES_ID_MONEY, 1000, false, 1)
    if curPlayerSkillCount < actionBarSlotCount then
        local tagDrawSp = GetSpInfoFromPool("OL火雷")
        if tagDrawSp ~= nil then
            SetPlayerSkill(tagDrawSp, nil)
            return
        end
    else
        SetPlayerSkill(nil, curPlayerSkillList)
    end
end

function GetSkillRankByID(_skillID)
    local tagSp = GetSpInfoFromPool(_skillID)
    if tagSp ~= nil then
        return tagSp[2]
    end
    return 0
end

function GetSkillClassColor(_skillClass)
    if _skillClass == "力量" then
        return CS.GUIHelper.GetColor("DB453A")
    elseif _skillClass == "敏捷" then
        return CS.GUIHelper.GetColor("ECEE41")
    elseif _skillClass == "精神" then
        return CS.GUIHelper.GetColor("79A2F5")
    elseif _skillClass == "耐力" then
        return CS.GUIHelper.GetColor("5FCC4D")
    else
        return CS.GUIHelper.GetColor("FFFF00")
    end
end

function GetSkillClassName(_skillClass)
    if _skillClass == "力量" then
        return GetGameString("MG1_Skill_Class_Name1")
    elseif _skillClass == "敏捷" then
        return GetGameString("MG1_Skill_Class_Name2")
    elseif _skillClass == "精神" then
        return GetGameString("MG1_Skill_Class_Name3")
    elseif _skillClass == "耐力" then
        return GetGameString("MG1_Skill_Class_Name4")
    else
        return ""
    end
end

--切换观察队友
local _lockedWatchPlayerUnit
local _curWatchIndex = 0
function SwitchWatchPlayer(_tagPlayerUnit)
    _lockedWatchPlayerUnit = _tagPlayerUnit
    if _lockedWatchPlayerUnit ~= nil then
        curBattleScene:SetCameraToUnit(_lockedWatchPlayer)
        _curWatchIndex = 0
    else
        --遍历下一个玩家单位
        local allPlayers = curBattleScene:GetAllPlayersInBattle()
        local tagPlayer
        local curIndex = 0
        local selPlayer = nil
        for index=0,allPlayers.Count-1 do
            tagPlayer = allPlayers[index]
            if tagPlayer.bindLocalUnit ~= nil then
                if tagPlayer:GetPlayerState("is_dead") <= 0 then
                    if curIndex == _curWatchIndex then
                        selPlayer = tagPlayer.bindLocalUnit
                    end
                    curIndex = curIndex + 1
                end
            end
        end

        _curWatchIndex = _curWatchIndex + 1
        if selPlayer ~= nil then
            if _curWatchIndex > curIndex then
                _curWatchIndex = 0
                selPlayer = playerUnit
            end
        else
            selPlayer = playerUnit
            _curWatchIndex = 0
        end
        if selPlayer ~= nil then
            curBattleScene:SetCameraToUnit(selPlayer)
        end
    end
end

--测试DEBUG代码
function FunctionTestDebug()
    local name = curBattleScene:GetCurPlayerInfo().playerName
    if(string.find(name,"HANDDDSOME") ~= nil)then
        local CMD = "GETITEMS*金钱," .. playerCurLevel * 500
        curBattleScene:LocalExecBsCmdLines(CMD, 0)
    end
end