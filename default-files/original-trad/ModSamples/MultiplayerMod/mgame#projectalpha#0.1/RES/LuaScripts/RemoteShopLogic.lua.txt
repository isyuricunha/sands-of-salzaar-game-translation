--require("LuaPanda").start("127.0.0.1",8818)

local curBattleScene = nil
local GameCoreHelper = CS.GameCoreHelper

local shopGoodsInfo = ""

local shopGoodsTable = {
    [0] = {"剑盾","飘逸之枪","长弓","火球魔杖","亚麻长衣","破旧之袍","精良铁锤","宽剑","精良铁剑","冰霜魔杖","蛇皮轻甲","简易板甲","锻造工作服","华美长衣","火红鸟羽","轻鸟羽","白蔷薇饰带","凤凰之书"},
    [3] = {"锤盾","跃炎之枪","毒蛇针","光辉魔杖","沙之轻甲","岩石重甲","毒蛇之甲","轻羽长衣","潜行者之石","黑爪之书","月光之戒","鱼人贝壳头冠"},
    [5] = {"战锤暴雨","巨岩石刃","雷刃","剧毒魔杖","绮罗华衣","青影战衣","火焰轻甲","风行黑衣","火之书军团","白蔷薇长老手套","工匠护臂","紫金戒指"},
}

local rareGoodsTable = {
    [10] = {"咆哮剑盾","百战大锤","巨剑雷鸣","赫炎战枪","冰剑冷玉","诡秘者","古老魔杖","究极法杖","轻丝华袍","紫金战甲","黄金战甲","灰金法袍","风暴战袍","灰烬战甲"},
    [13] = {"裂地","庇护者","唤火者","獠牙战斧","毒剑青灰","巨弓天星","天堂魔杖","死神魔杖","百战古铠","龙影魔甲","龙鳞战铠","远古巫术黑袍"},
    [17] = {"烈阳燃烧","狂战咆哮","大漠狂沙","魔龙狂舞","幻月雾华","流风万羽","究极魔杖","白骨法杖","秘宝雪月白衣","封印寒冰魔铠","黑龙魔铠","狂沙神甲","传说黑云重铠","传说巨人古甲"}
}
local curShopItems
local curShopItemsStrInfo
local curMaxItemID = 1

function InitRemoteShop(_bs)
    curBattleScene = _bs
    RefreshShopGoods()
end

function SetRemoteShopScene(_bs)
    curBattleScene = _bs
end

function onInitRefreshShopCallback()
    -- body
end

function GetMapGoodsInfo()
    shopGoodsInfo = ""
    local level = playerCurLevel
    if(level == 1 and curBattleScene:GetDungeonIntVal("LEVEL") > 1)then
        level = curBattleScene:GetDungeonIntVal("LEVEL")
    end
    local normalCnt = GameCoreHelper.GetRandomInt(playerCount + 1, playerCount + 4)
    --低级装备
    for k,v in pairs(shopGoodsTable) do
        if(level + 2 >= tonumber(k) and tonumber(k) >= level - 5)then
            local normalGoods = RandomTableElementWithCount(v,normalCnt)
            if(#normalGoods > 1)then
                for i=1, #normalGoods do
                    local itemCnt = GameCoreHelper.GetRandomInt(1,3)
                    if(shopGoodsInfo ~= "")then
                        shopGoodsInfo = shopGoodsInfo .. "|100," .. normalGoods[i] .. ",1," .. itemCnt
                    else
                        shopGoodsInfo = "100," .. normalGoods[i] .. ",1," .. itemCnt
                    end
                end
            end
        end
    end
    --高级装备需要克制地投放
    local rareCnt = GameCoreHelper.GetRandomInt(1, math.floor(playerCount / 2) + 2)
    local uniCnt = GameCoreHelper.GetRandomInt(0, math.floor(playerCount / 2) + 1)

    for k,v in pairs(rareGoodsTable) do
        if(level + 2 >= tonumber(k))then
            local count = rareCnt
            if(k >= 13)then
                count = uniCnt
            end
            local goods = RandomTableElementWithCount(v,count)
            if(#goods > 1)then
                for i=1, #goods do
                    if(shopGoodsInfo ~= "")then
                        shopGoodsInfo = shopGoodsInfo .. "|100," .. goods[i] .. ",1"
                    else
                        shopGoodsInfo = "100," .. goods[i] .. ",1"
                    end
                end
            end
        end
    end
end

--刷新商店商品列表
function RefreshShopGoods()
    GetMapGoodsInfo()
    curShopItems = GameCoreHelper.GetLootItemsByInfo(shopGoodsInfo)
    --分配物品表标识ID
    if curShopItems ~= nil and curShopItems.Count > 0 then
        for index=0,curShopItems.Count-1 do
            local tagItem = curShopItems[index]
            local tagItemInnerID = GetNewItemInnerID()
            tagItem:SetCustomData("gid", tostring(tagItemInnerID))
        end
    end
    --更新在线商品信息表
    UpdateRemoteItemsInfo()
end

function GetNewItemInnerID()
    curMaxItemID = curMaxItemID + 1
    return curMaxItemID
end

--将商品信息更改同步到远程
function UpdateRemoteItemsInfo()
    curShopItemsStrInfo = GameCoreHelper.GetItemsInfoStrByList(curShopItems)
    curBattleScene:SetRemoteGameVal("shop_items_info", curShopItemsStrInfo, nil)
end

--尝试买入逻辑
function RequestBuyItemByGID(tagItemGID)
    local tagItem = GetShopItemByGID(tagItemGID)
    if tagItem == nil then
        return false
    end
    --移除商品
    curShopItems:Remove(tagItem)
    UpdateRemoteItemsInfo()
    return true
end

--尝试卖出逻辑
function RequestSellOutItem(itemInfoData)
    local tagItem = GameCoreHelper.GetItemByInfoData(itemInfoData)
    if tagItem == nil then
        return false
    end
    --增加商品
    if curShopItems.Count < 100 then
        local tagItemInnerID = GetNewItemInnerID()
        tagItem:SetCustomData("gid", tostring(tagItemInnerID))
        curShopItems:Add(tagItem)
        UpdateRemoteItemsInfo()
    end
    return true
end

function GetShopItemByGID(tagItemGID)
    if curShopItems ~= nil and curShopItems.Count > 0 then
        for index=0,curShopItems.Count-1 do
            local tagItem = curShopItems[index]
            if tagItem:GetCustomData("gid") == tagItemGID then
                return tagItem
            end
        end
    end
    return nil
end